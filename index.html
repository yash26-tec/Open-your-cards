<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>2P Party Game — FIXED ✅</title>
  <style>
    :root{
      --bg:#f5f9ff; --card:#ffffff; --stroke:#dbe7ff;
      --blue:#1d4ed8; --blue2:#2563eb;
      --txt:#0f172a; --muted:#64748b;
      --shadow: 0 10px 26px rgba(15,23,42,.08);
      --r:18px;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{
      margin:0; min-height:100dvh;
      background:
        radial-gradient(1100px 520px at 50% -25%, rgba(37,99,235,.22), transparent 55%),
        radial-gradient(700px 380px at 0% 0%, rgba(29,78,216,.10), transparent 60%),
        linear-gradient(180deg,var(--bg),#fff);
      color:var(--txt);
      display:flex; justify-content:center; align-items:flex-start;
      padding:14px;
    }
    .app{width:min(520px,100%);display:grid;gap:12px;padding-bottom:96px}
    .topbar{ background:rgba(255,255,255,.92); border:1px solid var(--stroke); border-radius:var(--r); box-shadow:var(--shadow); padding:12px; backdrop-filter: blur(10px); }
    .titleRow{display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
    h1{margin:0;font-size:16px;letter-spacing:.2px}
    .sub{margin-top:4px;color:var(--muted);font-size:12px;line-height:1.3}
    .card{ background:rgba(255,255,255,.92); border:1px solid var(--stroke); border-radius:var(--r); box-shadow:var(--shadow); padding:12px; backdrop-filter: blur(10px); overflow:hidden; }
    .btn{ border:1px solid var(--stroke); background:linear-gradient(180deg,#ffffff,#f8fbff); color:var(--txt); border-radius:16px; padding:12px 12px; font-weight:1000; cursor:pointer; box-shadow:0 6px 14px rgba(15,23,42,.06); transition:transform .06s ease; user-select:none; }
    .btn.selected{ background:linear-gradient(135deg,var(--blue),var(--blue2)); color:#fff; border:0; }
    .btn:disabled{opacity:.45; cursor:not-allowed;}
    input{ width:100%; border:1px solid var(--stroke); border-radius:16px; padding:12px; background:#fff; outline:none; margin-bottom:8px;}
    .divider{height:1px;background:#eef2ff;margin:12px 0}
    .screen{display:none} .screen.show{display:block}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(29,78,216,.18);background:rgba(29,78,216,.08);color:#1e3a8a;font-weight:1000}
    .mono{font-family:monospace; background:#eee; padding:2px 4px; border-radius:4px}
  </style>
</head>
<body>

  <div class="app">
    <div class="topbar">
      <div class="titleRow">
        <div>
          <h1>2-Player Party Game</h1>
          <div class="sub" id="topSub">Status: Connecting...</div>
        </div>
      </div>
    </div>

    <div class="card screen show" id="screenHome">
      <div class="grid">
        <p><b>Create Room</b></p>
        <input id="myNameCreate" placeholder="Your name" />
        <button class="btn selected" id="btnCreateRoom">Create Room</button>
        
        <div class="divider"></div>
        
        <p><b>Join Room</b></p>
        <input id="roomIdJoin" placeholder="Enter Room Code" />
        <input id="myNameJoin" placeholder="Your name" />
        <button class="btn" id="btnJoinRoom">Join Room</button>
        <div id="homeErr" style="color:red; font-size:12px; margin-top:10px; display:none;"></div>
      </div>
    </div>

    <div class="card screen" id="screenLobby">
      <h3>Room: <span id="lobbyRoomId" class="mono"></span></h3>
      <p>Share this code with your friend!</p>
      <div class="divider"></div>
      <p>P1 (Host): <b id="lobbyP1">Waiting...</b></p>
      <p>P2 (Guest): <b id="lobbyP2">Waiting...</b></p>
      <div class="divider"></div>
      <button class="btn selected" id="startGame" disabled>Start Game</button>
      <button class="btn" onclick="location.reload()">Leave</button>
    </div>

    <div class="card screen" id="screenGame">
      <h3>Game Started!</h3>
      <p>Wait for next update...</p>
      <button class="btn" onclick="location.reload()">Reset Game</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, onValue, get, runTransaction, serverTimestamp, set } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    // --- CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyDDMj_YT8NRN-RYpksqjGOUTF5RzM5AgOM",
      authDomain: "power2-91fdc.firebaseapp.com",
      databaseURL: "https://power2-91fdc-default-rtdb.firebaseio.com",
      projectId: "power2-91fdc",
      storageBucket: "power2-91fdc.firebasestorage.app",
      messagingSenderId: "1096207181248",
      appId: "1:1096207181248:web:2fa473d9d8781616559425"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let client = { uid: "", name: "", roomId: "", role: "" };

    // --- HELPERS ---
    const el = (id) => document.getElementById(id);
    const showScreen = (id) => {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('show'));
      el(id).classList.add('show');
    };

    // --- AUTH ---
    signInAnonymously(auth).catch(console.error);
    onAuthStateChanged(auth, (user) => {
      if(user) {
        client.uid = user.uid;
        el("topSub").textContent = "Ready to Play ✅";
      }
    });

    // --- ROOM LOGIC ---
    async function createRoom() {
      const name = el("myNameCreate").value.trim() || "Host";
      const roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
      
      const roomRef = ref(db, `rooms/${roomId}`);
      await set(roomRef, {
        roomId,
        hostUid: client.uid,
        players: {
          p1: { uid: client.uid, name: name },
          p2: { uid: "", name: "" } // Important: Initialize empty
        },
        status: "waiting",
        createdAt: serverTimestamp()
      });

      client.roomId = roomId;
      client.role = "p1";
      startLobby(roomId);
    }

    async function joinRoom() {
      const roomId = el("roomIdJoin").value.trim().toUpperCase();
      const name = el("myNameJoin").value.trim() || "Player 2";
      const errEl = el("homeErr");
      
      if(!roomId) return;

      const roomRef = ref(db, `rooms/${roomId}`);
      
      try {
        const result = await runTransaction(roomRef, (room) => {
          if (!room) return; // Room doesn't exist

          // 1. Agar tum pehle se P1 ho (Same UID)
          if (room.players.p1.uid === client.uid) return room;

          // 2. Agar P2 khali hai ya tum hi P2 ho
          if (!room.players.p2.uid || room.players.p2.uid === "" || room.players.p2.uid === client.uid) {
            room.players.p2 = { uid: client.uid, name: name };
            return room;
          }

          // 3. Room Full
          return; 
        });

        if (result.committed && result.snapshot.exists()) {
          client.roomId = roomId;
          client.role = result.snapshot.val().players.p1.uid === client.uid ? "p1" : "p2";
          startLobby(roomId);
        } else {
          errEl.textContent = "Error: Room Full ya Code Galat hai!";
          errEl.style.display = "block";
        }
      } catch (e) {
        console.error(e);
      }
    }

    function startLobby(roomId) {
      showScreen("screenLobby");
      el("lobbyRoomId").textContent = roomId;

      onValue(ref(db, `rooms/${roomId}`), (snap) => {
        const data = snap.val();
        if(!data) return;

        el("lobbyP1").textContent = data.players.p1.name;
        el("lobbyP2").textContent = data.players.p2.uid ? data.players.p2.name : "Waiting for friend...";

        if(data.players.p2.uid) {
          el("startGame").disabled = (client.role !== "p1");
          el("startGame").textContent = (client.role === "p1") ? "Start Game" : "Wait for Host";
        }

        if(data.status === "playing") {
          showScreen("screenGame");
        }
      });
    }

    // --- LISTENERS ---
    el("btnCreateRoom").onclick = createRoom;
    el("btnJoinRoom").onclick = joinRoom;
    el("startGame").onclick = async () => {
      await set(ref(db, `rooms/${client.roomId}/status`), "playing");
    };

    // Link se auto-fill room code
    const urlParams = new URLSearchParams(window.location.search);
    if(urlParams.get('room')) {
      el("roomIdJoin").value = urlParams.get('room');
    }

  </script>
</body>
</html>
