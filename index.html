<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>2P Party Game (Firebase Rooms) — FINAL (Room Full + Kick Fixed ✅)</title>
  <style>
    :root{
      --bg:#f5f9ff; --card:#ffffff; --stroke:#dbe7ff;
      --blue:#1d4ed8; --blue2:#2563eb;
      --txt:#0f172a; --muted:#64748b;
      --shadow: 0 10px 26px rgba(15,23,42,.08);
      --r:18px;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{
      margin:0; min-height:100dvh;
      background:
        radial-gradient(1100px 520px at 50% -25%, rgba(37,99,235,.22), transparent 55%),
        radial-gradient(700px 380px at 0% 0%, rgba(29,78,216,.10), transparent 60%),
        linear-gradient(180deg,var(--bg),#fff);
      color:var(--txt);
      display:flex; justify-content:center; align-items:flex-start;
      padding:14px;
    }
    .app{width:min(520px,100%);display:grid;gap:12px;padding-bottom:96px}

    .topbar{
      background:rgba(255,255,255,.92);
      border:1px solid var(--stroke);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:12px;
      backdrop-filter: blur(10px);
    }
    .titleRow{display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
    h1{margin:0;font-size:16px;letter-spacing:.2px}
    .sub{margin-top:4px;color:var(--muted);font-size:12px;line-height:1.3}

    .seg{
      display:flex;gap:8px;margin-top:10px;
      background:linear-gradient(180deg,#eef6ff,#f7fbff);
      padding:6px;border-radius:999px;border:1px solid var(--stroke)
    }
    .seg button{
      flex:1;border:0;border-radius:999px;padding:10px;cursor:pointer;background:transparent;
      color:var(--muted);font-weight:1000;letter-spacing:.2px
    }
    .seg button.active{
      background:linear-gradient(135deg,var(--blue),var(--blue2));
      color:#fff;box-shadow:0 10px 20px rgba(29,78,216,.22)
    }

    .card{
      background:rgba(255,255,255,.92);
      border:1px solid var(--stroke);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:12px;
      backdrop-filter: blur(10px);
      overflow:hidden;
    }

    .qBox{
      border:1px dashed #c7d8ff;
      background:linear-gradient(180deg,#f8fbff,#ffffff);
      border-radius:16px;
      padding:14px;
      min-height:110px;
      display:flex;flex-direction:column;justify-content:center;gap:8px;
    }
    .qText{font-size:18px;font-weight:1000;line-height:1.25}
    .qMeta{font-size:12px;color:var(--muted);display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center}

    .prog{
      height:8px;border-radius:999px;background:#eef4ff;border:1px solid var(--stroke);
      overflow:hidden; flex:1; min-width:140px;
    }
    .prog > i{
      display:block;height:100%;
      width:0%;
      background:linear-gradient(135deg,var(--blue),var(--blue2));
      border-radius:999px;
      box-shadow:0 10px 22px rgba(29,78,216,.20);
      transition:width .25s ease;
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    .btn{
      border:1px solid var(--stroke);
      background:linear-gradient(180deg,#ffffff,#f8fbff);
      color:var(--txt);
      border-radius:16px;
      padding:12px 12px;
      font-weight:1000;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(15,23,42,.06);
      transition:transform .06s ease, box-shadow .12s ease, filter .12s ease;
      user-select:none;
      position:relative;
      overflow:hidden;
    }
    .btn:hover{filter:brightness(1.02)}
    .btn:active{transform:scale(.99)}
    .btn:disabled{opacity:.45; cursor:not-allowed; transform:none}
    .btn.selected{
      background:linear-gradient(135deg,var(--blue),var(--blue2));
      color:#fff;border:0;
      box-shadow:0 14px 30px rgba(29,78,216,.26);
    }
    .btn.ghost{background:linear-gradient(180deg,#f1f7ff,#ffffff)}
    .btn.danger{
      background:linear-gradient(180deg,#fff5f7,#ffffff);
      border:1px solid #ffd2da;color:#b91c1c
    }

    .pill{
      font-size:12px;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(29,78,216,.18);
      background:rgba(29,78,216,.08);
      color:#1e3a8a;font-weight:1000
    }

    input{
      width:100%;
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:12px;
      background:#fff;
      outline:none;
      box-shadow:0 6px 14px rgba(15,23,42,.04);
    }

    .bottomBar{
      position:fixed;left:0;right:0;bottom:0;
      background:rgba(255,255,255,.9);
      backdrop-filter: blur(10px);
      border-top:1px solid var(--stroke);
      padding:10px;
      padding-bottom: calc(10px + env(safe-area-inset-bottom));
      display:flex;justify-content:center
    }
    .bottomInner{width:min(520px,100%);display:flex;gap:10px}
    .bottomInner .btn{flex:1}

    .overlay{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:flex-end;justify-content:center;padding:14px}
    .overlay.show{display:flex}
    .sheet{
      width:min(520px,100%);
      background:rgba(255,255,255,.96);
      border-radius:20px;
      border:1px solid var(--stroke);
      box-shadow:0 18px 55px rgba(0,0,0,.25);
      padding:12px;
      max-height:82vh;
      overflow:auto;
      backdrop-filter: blur(12px);
    }
    .sheetTop{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .sheetTitle{font-weight:1000}
    .xbtn{border:1px solid var(--stroke);background:#fff;border-radius:14px;padding:10px 12px;cursor:pointer;font-weight:1000}
    .hint{font-size:12px;color:var(--muted);margin:8px 0 10px;line-height:1.35}
    .divider{height:1px;background:#eef2ff;margin:12px 0}
    .grid{display:grid;gap:10px}
    .miniRow{display:flex;gap:10px}
    .miniRow > *{flex:1}
    .list{margin-top:10px;border:1px solid var(--stroke);border-radius:16px;padding:10px;background:#f8fbff}
    .listItem{display:flex;justify-content:space-between;gap:10px;padding:10px;border-radius:14px;background:#fff;border:1px solid var(--stroke);margin-bottom:8px;font-size:13px}
    .listItem:last-child{margin-bottom:0}
    .del{border:1px solid #ffd2da;background:#fff5f7;color:#b91c1c;border-radius:14px;padding:8px 10px;cursor:pointer;font-weight:1000;white-space:nowrap}
    .tiny{font-size:12px;color:var(--muted)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    .scoreGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .scoreCard{
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:12px;
      background:linear-gradient(180deg,#ffffff,#f8fbff);
      box-shadow:0 10px 22px rgba(15,23,42,.06);
      position:relative;
      overflow:hidden;
      transition:transform .10s ease, box-shadow .12s ease;
    }
    .scoreTop{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
    .scoreName{font-weight:1000;font-size:13px}
    .scoreNum{font-size:32px;font-weight:1000;color:var(--blue);line-height:1}
    .scoreCard.active{
      transform:translateY(-1px);
      box-shadow:0 16px 36px rgba(29,78,216,.14);
      border-color:rgba(29,78,216,.35);
    }
    .scoreCard.active::before{
      content:"";
      position:absolute; inset:0;
      background:radial-gradient(280px 140px at 20% 0%, rgba(37,99,235,.18), transparent 60%);
      pointer-events:none;
    }

    .nhieSelectedGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .selCard{
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:12px;
      background:linear-gradient(180deg,#ffffff,#f8fbff);
      box-shadow:0 8px 18px rgba(15,23,42,.05);
      display:grid; gap:8px;
    }
    .selHeader{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .selMini{font-size:12px;color:var(--muted);font-weight:900}
    .selBadge{
      font-size:12px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--stroke);
      background:#fff;
      font-weight:1000;
      color:var(--muted);
    }
    .selBadge.done{
      border:1px solid rgba(29,78,216,.25);
      background:rgba(29,78,216,.10);
      color:#0b2a7a;
    }
    .selValue{
      font-size:16px;font-weight:1000;line-height:1.2;
      padding:12px 12px;border-radius:14px;
      border:1px solid var(--stroke);
      background:#fff;
    }
    .selValue.selected{
      border:1px solid rgba(29,78,216,.25);
      background:rgba(29,78,216,.10);
      color:#0b2a7a;
    }

    .actionBoard{
      margin-top:10px;
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:12px;
      background:linear-gradient(180deg,#ffffff,#f7fbff);
      display:grid; gap:10px;
    }
    .actionHeader{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .status{font-size:12px;color:var(--muted)}
    .bigRow{display:flex;gap:10px}
    .bigRow .btn{flex:1;padding:14px;border-radius:18px;font-size:14px}

    .pickSelectedGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .pickSelCard{
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:12px;
      background:linear-gradient(180deg,#ffffff,#f8fbff);
      box-shadow:0 8px 18px rgba(15,23,42,.05);
    }
    .pickSelName{font-weight:1000;font-size:13px}
    .pickSelValue{
      margin-top:8px;
      font-size:18px;font-weight:1000;line-height:1.2;
      padding:12px 12px;border-radius:14px;
      border:1px solid var(--stroke);
      background:#fff;
    }
    .pickSelValue.selected{
      border:1px solid rgba(29,78,216,.25);
      background:rgba(29,78,216,.10);
      color:#0b2a7a;
    }

    .screen{display:none}
    .screen.show{display:block}

    .roomCard{
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:12px;
      background:linear-gradient(180deg,#ffffff,#f8fbff);
      box-shadow:0 10px 22px rgba(15,23,42,.06);
      display:grid; gap:10px;
    }
    .roomTitle{font-weight:1000}
    .roomLine{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .copyRow{display:flex;gap:10px}
    .copyRow .btn{flex:0 0 auto; padding:10px 12px}
    .copyRow input{flex:1}
    .centerNote{font-size:12px;color:var(--muted);line-height:1.35}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="titleRow">
        <div>
          <h1>2-Player Party Game</h1>
          <div class="sub" id="topSub">Firebase realtime rooms enabled ✅</div>
        </div>
        <button class="btn ghost" id="openAdmin">Manage</button>
      </div>
      <div class="seg" id="modeSeg" style="display:none;">
        <button id="tabNhie" class="active">Never Have I Ever</button>
        <button id="tabPick">Pick One</button>
      </div>
    </div>

    <!-- HOME -->
    <div class="card screen show" id="screenHome">
      <div class="roomCard">
        <div class="roomTitle">Play with a friend (real-time)</div>
        <div class="centerNote">Create room → share link → friend joins → host starts → live sync.</div>
        <div class="divider"></div>

        <div class="grid">
          <div class="hint"><b>Create Room</b></div>
          <input id="myNameCreate" placeholder="Your name" />
          <button class="btn selected" id="btnCreateRoom">Create Room</button>
        </div>

        <div class="divider"></div>

        <div class="grid">
          <div class="hint"><b>Join Room</b></div>
          <input id="roomIdJoin" placeholder="Room code (e.g. AB12CD) or paste full link" />
          <input id="myNameJoin" placeholder="Your name" />
          <button class="btn" id="btnJoinRoom">Join Room</button>
        </div>

        <div class="tiny" id="homeErr" style="display:none;color:#b91c1c;font-weight:900;"></div>
        <div class="tiny" id="authInfo" style="margin-top:6px;"></div>
      </div>
    </div>

    <!-- LOBBY -->
    <div class="card screen" id="screenLobby">
      <div class="roomCard">
        <div class="roomTitle">Room Lobby</div>

        <div class="roomLine">
          <span class="pill">Room</span>
          <span class="mono" id="lobbyRoomId">—</span>
          <span class="pill" id="lobbyRolePill">Role: —</span>
        </div>

        <div class="copyRow">
          <input id="shareLink" readonly />
          <button class="btn selected" id="copyLink">Copy Link</button>
        </div>

        <div class="divider"></div>

        <div class="grid">
          <div class="hint">Players</div>
          <div class="scoreGrid">
            <div class="scoreCard">
              <div class="scoreTop">
                <div class="scoreName" id="lobbyP1">Waiting…</div>
                <div class="pill">P1</div>
              </div>
            </div>
            <div class="scoreCard">
              <div class="scoreTop">
                <div class="scoreName" id="lobbyP2">Waiting…</div>
                <div class="pill">P2</div>
              </div>
            </div>
          </div>
          <div class="centerNote" id="lobbyHint">Waiting for Player 2 to join…</div>
        </div>

        <!-- ✅ Kick added -->
        <div class="row" style="justify-content:space-between">
          <button class="btn danger" id="leaveRoom">Leave</button>
          <button class="btn danger" id="kickP2" style="display:none;">Kick P2</button>
          <button class="btn selected" id="startGame" disabled>Start Game</button>
        </div>

        <div class="tiny" id="lobbyErr" style="display:none;color:#b91c1c;font-weight:900;"></div>
      </div>
    </div>

    <!-- GAME -->
    <div class="card screen" id="screenGame">
      <div class="qBox">
        <div class="qText" id="qText">Loading…</div>
        <div class="qMeta">
          <span id="qMeta">—</span>
          <div class="prog" aria-hidden="true"><i id="progFill"></i></div>
        </div>
      </div>

      <div id="nhieArea">
        <div class="scoreGrid">
          <div class="scoreCard" id="scoreP1">
            <div class="scoreTop">
              <div class="scoreName" id="p1Name">Player 1</div>
              <div class="scoreNum" id="p1Count">0</div>
            </div>
          </div>
          <div class="scoreCard" id="scoreP2">
            <div class="scoreTop">
              <div class="scoreName" id="p2Name">Player 2</div>
              <div class="scoreNum" id="p2Count">0</div>
            </div>
          </div>
        </div>

        <div class="nhieSelectedGrid">
          <div class="selCard">
            <div class="selHeader">
              <div class="selMini" id="p1SelMini">Player 1 • Selection</div>
              <span class="selBadge" id="p1Badge">Pending</span>
            </div>
            <div class="selValue" id="p1SelBox">—</div>
          </div>

          <div class="selCard">
            <div class="selHeader">
              <div class="selMini" id="p2SelMini">Player 2 • Selection</div>
              <span class="selBadge" id="p2Badge">Pending</span>
            </div>
            <div class="selValue" id="p2SelBox">—</div>
          </div>
        </div>

        <div class="actionBoard">
          <div class="actionHeader">
            <span class="pill" id="nhieTurnPill">Turn: —</span>
            <span class="status" id="nhieStatus">Select your answer.</span>
          </div>
          <div class="bigRow">
            <button class="btn" id="nhieHave">I Have</button>
            <button class="btn" id="nhieNever">I Never</button>
          </div>
        </div>
      </div>

      <div id="pickArea" style="display:none; margin-top:10px;">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <span class="pill" id="pickTurnPill">Turn: —</span>
          <span class="tiny" id="pickStatus">Select an option.</span>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" id="opt1Btn" style="flex:1;">Option 1</button>
          <button class="btn" id="opt2Btn" style="flex:1;">Option 2</button>
        </div>

        <div class="pickSelectedGrid">
          <div class="pickSelCard">
            <div class="pickSelName" id="p1Name2">Player 1</div>
            <div class="pickSelValue" id="p1PickBox">—</div>
          </div>
          <div class="pickSelCard">
            <div class="pickSelName" id="p2Name2">Player 2</div>
            <div class="pickSelValue" id="p2PickBox">—</div>
          </div>
        </div>

        <div class="tiny" style="margin-top:8px;">Pick One has no score. Only selections are shown.</div>
      </div>

      <div class="tiny" style="margin-top:10px;">
        Room: <span class="mono" id="gameRoomId">—</span> • You are: <span class="mono" id="gameMeRole">—</span>
      </div>
    </div>
  </div>

  <div class="bottomBar">
    <div class="bottomInner">
      <button class="btn ghost" id="reset">Reset</button>
      <button class="btn selected" id="next">Next</button>
    </div>
  </div>

  <!-- Manage Sheet -->
  <div class="overlay" id="overlay">
    <div class="sheet">
      <div class="sheetTop">
        <div class="sheetTitle">Manage</div>
        <button class="xbtn" id="closeSheet">✕</button>
      </div>

      <div id="adminLogin">
        <div class="hint">Password required</div>
        <form autocomplete="off" onsubmit="return false;">
          <input type="text" style="display:none" autocomplete="username">
          <input type="password" style="display:none" autocomplete="new-password">
          <div class="row">
            <input id="adminPass" type="password" placeholder="Password"
                   name="admin_pass__no_fill" autocomplete="new-password"
                   autocapitalize="none" autocorrect="off" spellcheck="false"
                   data-lpignore="true" data-1p-ignore="true" readonly />
            <button class="btn selected" id="unlock" type="button">Unlock</button>
          </div>
        </form>
      </div>

      <div id="adminPanel" style="display:none;">
        <div class="hint">Manage questions here (saved on this phone).</div>

        <div class="divider"></div>

        <div class="grid">
          <div class="hint"><b>Never Have I Ever</b> – Add one question:</div>
          <input id="nhieNew" placeholder="e.g. Never have I ever skipped class"/>
          <div class="row">
            <button class="btn selected" id="addNhie">Add</button>
            <button class="btn danger" id="clearNhie">Clear All</button>
          </div>
          <div class="list" id="nhieList"></div>
        </div>

        <div class="divider"></div>

        <div class="grid">
          <div class="hint"><b>Pick One</b> – Easy add:</div>
          <input id="pickQ" placeholder="Question (optional) e.g. Pick one"/>
          <div class="miniRow">
            <input id="pickO1" placeholder="Option 1"/>
            <input id="pickO2" placeholder="Option 2"/>
          </div>
          <div class="row">
            <button class="btn selected" id="addPick">Add</button>
            <button class="btn danger" id="clearPick">Clear All</button>
          </div>
          <div class="list" id="pickList"></div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <button class="btn ghost" id="loadSample">Load Sample</button>
          <button class="btn danger" id="wipeAll">Reset Everything</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, onValue, off, get, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDDMj_YT8NRN-RYpksqjGOUTF5RzM5AgOM",
      authDomain: "power2-91fdc.firebaseapp.com",
      databaseURL: "https://power2-91fdc-default-rtdb.firebaseio.com",
      projectId: "power2-91fdc",
      storageBucket: "power2-91fdc.firebasestorage.app",
      messagingSenderId: "1096207181248",
      appId: "1:1096207181248:web:2fa473d9d8781616559425",
      measurementId: "G-ZR2CT9GRHV"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const el = (id) => document.getElementById(id);
    const show = (id) => el(id).classList.add("show");
    const hide = (id) => el(id).classList.remove("show");
    const setText = (id, v) => el(id).textContent = v;
    const clampName = (s, fallback) => (String(s||"").trim() || fallback).slice(0, 24);

    function cleanRoomId(s){ return (String(s||"").toUpperCase().trim().replace(/[^A-Z0-9]/g, "")).slice(0, 10); }
    function extractRoomIdFromInput(raw){
      const s = String(raw || "").trim();
      if(!s) return "";
      if(s.includes("://") || s.startsWith("www.")){
        try{
          const u = new URL(s.startsWith("www.") ? ("https://" + s) : s);
          const fromParam = u.searchParams.get("room") || "";
          if(fromParam) return cleanRoomId(fromParam);
        }catch{}
      }
      return cleanRoomId(s);
    }
    function genRoomId(){
      const chars = "ABCDEFGHJKMNPQRSTUVWXYZ23456789";
      let out = ""; for(let i=0;i<6;i++) out += chars[Math.floor(Math.random()*chars.length)];
      return out;
    }
    function deepClone(x){ return JSON.parse(JSON.stringify(x)); }
    function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } }
    function buildOrder(len){ const order = Array.from({length:len}, (_,i)=>i); shuffle(order); return order; }

    // session token (for orphan reclaim)
    function makeToken(){ return Math.random().toString(36).slice(2) + "-" + Date.now().toString(36); }
    const SESSION_KEY = "party_session_token_v2";
    const sessionToken = localStorage.getItem(SESSION_KEY) || makeToken();
    localStorage.setItem(SESSION_KEY, sessionToken);

    // Questions local
    const QKEY = "party_questions_local_v2";
    const ADMIN_PASSWORD = "Admin@123";
    const SAMPLE_Q = {
      nhie:[
        "Never have I ever lied to my parents",
        "Never have I ever ghosted someone",
        "Never have I ever skipped a class",
        "Never have I ever stalked someone’s profile"
      ],
      pick:[
        {q:"Pick one", o1:"Pizza", o2:"Burger"},
        {q:"Pick one", o1:"Netflix", o2:"YouTube"},
        {q:"Pick one", o1:"Beach", o2:"Mountains"}
      ]
    };
    const questions = { nhie:[], pick:[] };
    function loadQuestions(){
      try{
        const v = JSON.parse(localStorage.getItem(QKEY));
        if(!v) throw 0;
        questions.nhie = Array.isArray(v.nhie) ? v.nhie : [];
        questions.pick = Array.isArray(v.pick) ? v.pick : [];
      }catch{
        questions.nhie = deepClone(SAMPLE_Q.nhie);
        questions.pick = deepClone(SAMPLE_Q.pick);
        saveQuestions();
      }
    }
    function saveQuestions(){ localStorage.setItem(QKEY, JSON.stringify(questions)); }

    function makeNewRoomDoc({roomId, hostUid, hostName, q, hostSession}){
      const now = Date.now();
      return {
        roomId,
        status: "waiting",
        hostUid,
        players: {
          p1: { uid: hostUid, name: hostName, session: hostSession, lastSeen: now },
          p2: { uid: "", name: "", session: "", lastSeen: 0 }
        },
        mode: "nhie",
        idx: 0,
        order: buildOrder((q?.nhie||[]).length),
        questions: q || {nhie:[], pick:[]},
        state: {
          counts: {p1:0,p2:0},
          last: {p1:"—",p2:"—"},
          nhieTurn: "p1",
          nhieAnswered: {p1:false,p2:false},
          pickLast: {p1:"—",p2:"—"},
          pickTurn: "p1",
          pickAnswered: {p1:false,p2:false},
        },
        updatedAt: serverTimestamp()
      };
    }

    const RoomAPI = (() => {
      const roomRef = (rid) => ref(db, `rooms/${rid}`);

      async function createRoom({hostUid, hostName, q, session}){
        for(let t=0; t<10; t++){
          const roomId = genRoomId();
          const r = roomRef(roomId);

          const res = await runTransaction(r, (current) => {
            if(current !== null) return;
            return makeNewRoomDoc({roomId, hostUid, hostName, q, hostSession: session});
          }, { applyLocally:false });

          if(res.committed) return { roomId, role:"p1" };
        }
        throw new Error("Could not create room. Try again.");
      }

      // ✅ JOIN (fixed): orphan reclaim + better full error detail
      async function joinRoom({roomId, uid, name, session}){
        const rid = extractRoomIdFromInput(roomId);
        if(!rid) throw new Error("Please enter Room code OR paste full link.");

        const r = roomRef(rid);
        const pre = await get(r);
        if(!pre.exists()) throw new Error("Room not found");

        const STALE_MS = 30 * 1000; // fast reclaim
        const res = await runTransaction(r, (doc) => {
          if(!doc) return;

          doc.players = doc.players || {p1:{uid:"",name:"",session:"",lastSeen:0}, p2:{uid:"",name:"",session:"",lastSeen:0}};
          doc.players.p1 = doc.players.p1 || {uid:"",name:"",session:"",lastSeen:0};
          doc.players.p2 = doc.players.p2 || {uid:"",name:"",session:"",lastSeen:0};

          const now = Date.now();

          // rejoin by uid (p1 / p2)
          if(doc.players.p1.uid === uid){
            doc.players.p1.name = name || doc.players.p1.name;
            doc.players.p1.session = doc.players.p1.session || session;
            doc.players.p1.lastSeen = now;
            doc.updatedAt = serverTimestamp();
            return doc;
          }
          if(doc.players.p2.uid === uid){
            doc.players.p2.name = name || doc.players.p2.name;
            doc.players.p2.session = doc.players.p2.session || session;
            doc.players.p2.lastSeen = now;
            doc.updatedAt = serverTimestamp();
            return doc;
          }

          // IMPORTANT: prevent same uid taking both slots
          if(doc.players.p1.uid && doc.players.p1.uid === uid){
            return doc;
          }

          const p2uid = String(doc.players.p2.uid || "");
          const p2session = String(doc.players.p2.session || "");
          const p2last = Number(doc.players.p2.lastSeen || 0);

          const p2Occupied = !!p2uid;

          // ✅ ORPHAN reclaim rules (only in waiting)
          const waiting = (doc.status === "waiting");
          const stale = waiting && p2Occupied && (now - p2last > STALE_MS);
          const orphan = waiting && p2Occupied && (!p2session || p2last === 0); // THIS fixes “fresh full” from half-written p2
          const sameSession = waiting && p2Occupied && (p2session === session);

          if(p2Occupied && !(stale || orphan || sameSession)){
            return; // abort => full
          }

          // claim p2
          doc.players.p2.uid = uid;
          doc.players.p2.name = name;
          doc.players.p2.session = session;
          doc.players.p2.lastSeen = now;
          doc.updatedAt = serverTimestamp();
          return doc;

        }, { applyLocally:false });

        if(!res.committed){
          const snap = await get(r);
          const d = snap.val();
          const who = d?.players?.p2?.name || "Unknown";
          const uid2 = (d?.players?.p2?.uid || "").slice(0,8);
          throw new Error(`Room is full (P2: ${who} • uid:${uid2 || "—"}). Host can Kick P2.`);
        }

        const doc = res.snapshot.val();
        if(doc.players?.p1?.uid === uid) return { role:"p1", roomId: rid };
        if(doc.players?.p2?.uid === uid) return { role:"p2", roomId: rid };
        throw new Error("Join failed");
      }

      function subscribeRoom(roomId, cb){
        const rid = extractRoomIdFromInput(roomId);
        const r = roomRef(rid);
        const handler = (snap) => cb(snap.exists() ? snap.val() : null);
        onValue(r, handler);
        return () => off(r, "value", handler);
      }

      async function patchRoom(roomId, patchFn){
        const rid = extractRoomIdFromInput(roomId);
        const r = roomRef(rid);
        const res = await runTransaction(r, (doc) => {
          if(!doc) return doc;
          const next = patchFn(deepClone(doc));
          next.updatedAt = serverTimestamp();
          return next;
        }, { applyLocally:false });
        if(!res.committed) throw new Error("Update failed. Try again.");
      }

      async function leaveRoom(roomId, uid){
        const rid = extractRoomIdFromInput(roomId);
        const r = roomRef(rid);

        await runTransaction(r, (doc) => {
          if(!doc) return doc;
          const p1 = doc.players?.p1?.uid;
          const p2 = doc.players?.p2?.uid;

          if(p1 === uid) return null; // host leaves => delete room

          if(p2 === uid){
            doc.players.p2 = {uid:"", name:"", session:"", lastSeen:0};
            doc.status = "waiting";
            doc.idx = 0;

            doc.state.last = {p1:"—",p2:"—"};
            doc.state.nhieAnswered = {p1:false,p2:false};
            doc.state.nhieTurn = "p1";

            doc.state.pickLast = {p1:"—",p2:"—"};
            doc.state.pickAnswered = {p1:false,p2:false};
            doc.state.pickTurn = "p1";
            doc.updatedAt = serverTimestamp();
          }
          return doc;
        }, { applyLocally:false });
      }

      // ✅ REAL KICK P2 (host only)
      async function kickP2(roomId, hostUid){
        const rid = extractRoomIdFromInput(roomId);
        const r = roomRef(rid);
        await runTransaction(r, (doc) => {
          if(!doc) return doc;
          if(doc.hostUid !== hostUid) return doc; // only host

          doc.players = doc.players || {};
          doc.players.p2 = {uid:"", name:"", session:"", lastSeen:0};

          doc.status = "waiting";
          doc.idx = 0;

          doc.state.last = {p1:"—",p2:"—"};
          doc.state.nhieAnswered = {p1:false,p2:false};
          doc.state.nhieTurn = "p1";

          doc.state.pickLast = {p1:"—",p2:"—"};
          doc.state.pickAnswered = {p1:false,p2:false};
          doc.state.pickTurn = "p1";

          doc.updatedAt = serverTimestamp();
          return doc;
        }, { applyLocally:false });
      }

      return { createRoom, joinRoom, subscribeRoom, patchRoom, leaveRoom, kickP2 };
    })();

    const client = { uid:"", roomId:"", role:"", room:null, unsub:null, session: sessionToken };

    function setScreen(name){
      ["screenHome","screenLobby","screenGame"].forEach(id => hide(id));
      show(name);
      const isGame = name === "screenGame";
      el("reset").disabled = !isGame;
      el("next").disabled  = !isGame;
      el("modeSeg").style.display = isGame ? "flex" : "none";
    }
    function showHomeError(msg){ el("homeErr").style.display = msg ? "block" : "none"; el("homeErr").textContent = msg || ""; }
    function showLobbyError(msg){ el("lobbyErr").style.display = msg ? "block" : "none"; el("lobbyErr").textContent = msg || ""; }

    function buildShareLink(roomId){
      const u = new URL(window.location.href);
      u.searchParams.set("room", cleanRoomId(roomId));
      return u.toString();
    }

    function cleanupRoom(){
      if(client.unsub) client.unsub();
      client.unsub = null;
      client.room = null;
      client.roomId = "";
      client.role = "";
    }

    function subscribeRoom(roomId){
      if(client.unsub) client.unsub();
      client.unsub = RoomAPI.subscribeRoom(roomId, (doc) => {
        client.room = doc;
        if(!doc){
          cleanupRoom();
          setScreen("screenHome");
          showHomeError("Room ended or deleted.");
          return;
        }
        renderFromRoom(doc);
      });
    }

    function getQ(room){ return room.questions || {nhie:[], pick:[]}; }
    function getCurrentItem(room){
      const q = getQ(room);
      const list = room.mode === "nhie" ? (q.nhie||[]) : (q.pick||[]);
      if(!list.length) return null;
      const realIdx = room.order?.[room.idx] ?? 0;
      return list[realIdx] ?? null;
    }
    function setProgress(room){
      const q = getQ(room);
      const total = room.mode === "nhie" ? (q.nhie||[]).length : (q.pick||[]).length;
      const pct = total ? Math.round(((room.idx+1)/total)*100) : 0;
      el("progFill").style.width = pct + "%";
    }
    function setModeUI(room){
      el("tabNhie").classList.toggle("active", room.mode === "nhie");
      el("tabPick").classList.toggle("active", room.mode === "pick");
      el("nhieArea").style.display = room.mode === "nhie" ? "block" : "none";
      el("pickArea").style.display = room.mode === "pick" ? "block" : "none";
    }

    function updateNhieUI(room){
      const a1 = room.state.last.p1 || "—";
      const a2 = room.state.last.p2 || "—";
      el("p1SelMini").textContent = (room.players.p1.name || "Player 1") + " • Selection";
      el("p2SelMini").textContent = (room.players.p2.name || "Player 2") + " • Selection";
      setText("p1SelBox", a1); setText("p2SelBox", a2);
      el("p1SelBox").classList.toggle("selected", a1 !== "—");
      el("p2SelBox").classList.toggle("selected", a2 !== "—");

      const d1 = !!room.state.nhieAnswered.p1;
      const d2 = !!room.state.nhieAnswered.p2;
      setText("p1Badge", d1 ? "Done" : "Pending");
      setText("p2Badge", d2 ? "Done" : "Pending");
      el("p1Badge").classList.toggle("done", d1);
      el("p2Badge").classList.toggle("done", d2);

      const turn = room.state.nhieTurn;
      setText("nhieTurnPill", "Turn: " + (turn==="p1" ? (room.players.p1.name||"P1") : (room.players.p2.name||"P2")));

      const both = d1 && d2;
      if(both){
        setText("nhieStatus", "Both answered ✅ Host can tap Next.");
        el("nhieHave").disabled = true;
        el("nhieNever").disabled = true;
      }else{
        const tName = turn==="p1" ? (room.players.p1.name||"P1") : (room.players.p2.name||"P2");
        setText("nhieStatus", tName + " select: I Have / I Never");
        const myTurn = client.role === turn;
        el("nhieHave").disabled = !myTurn;
        el("nhieNever").disabled = !myTurn;
      }

      const sel = room.state.last[turn];
      el("nhieHave").classList.toggle("selected", sel === "I Have");
      el("nhieNever").classList.toggle("selected", sel === "I Never");
    }

    function updatePickUI(room){
      const t = room.state.pickTurn;
      setText("pickTurnPill", "Turn: " + (t==="p1" ? (room.players.p1.name||"P1") : (room.players.p2.name||"P2")));

      const v1 = room.state.pickLast.p1 || "—";
      const v2 = room.state.pickLast.p2 || "—";
      setText("p1PickBox", v1);
      setText("p2PickBox", v2);
      el("p1PickBox").classList.toggle("selected", v1 !== "—");
      el("p2PickBox").classList.toggle("selected", v2 !== "—");

      const a1 = !!room.state.pickAnswered.p1;
      const a2 = !!room.state.pickAnswered.p2;
      const both = a1 && a2;

      if(both){
        setText("pickStatus", "Both answered ✅ Host can tap Next.");
        el("opt1Btn").disabled = true;
        el("opt2Btn").disabled = true;
      }else{
        const tName = t==="p1" ? (room.players.p1.name||"P1") : (room.players.p2.name||"P2");
        setText("pickStatus", tName + " select an option.");
        const myTurn = client.role === t;
        el("opt1Btn").disabled = !myTurn;
        el("opt2Btn").disabled = !myTurn;
      }

      const sel = room.state.pickLast[t];
      const o1 = el("opt1Btn").textContent || "Option 1";
      const o2 = el("opt2Btn").textContent || "Option 2";
      el("opt1Btn").classList.toggle("selected", sel && sel !== "—" && sel === o1);
      el("opt2Btn").classList.toggle("selected", sel && sel !== "—" && sel === o2);
    }

    function renderFromRoom(room){
      // Lobby
      setText("lobbyRoomId", room.roomId);
      setText("lobbyP1", room.players.p1.name || "Waiting…");
      setText("lobbyP2", room.players.p2.name || "Waiting…");
      setText("lobbyRolePill", "Role: " + (client.role || "—"));
      el("shareLink").value = buildShareLink(room.roomId);

      const bothJoined = !!(room.players.p1.uid && room.players.p2.uid);
      el("startGame").disabled = !(bothJoined && client.role === "p1");

      // ✅ Kick button visibility
      const isHost = client.role === "p1" && client.uid === room.hostUid;
      const p2Present = !!(room.players?.p2?.uid);
      el("kickP2").style.display = (isHost ? "inline-block" : "none");
      el("kickP2").disabled = !p2Present;

      if(room.status === "waiting"){
        setScreen("screenLobby");
        el("lobbyHint").textContent = bothJoined
          ? "Both players joined ✅ Host can start the game."
          : "Waiting for Player 2 to join…";
      }
      if(room.status === "playing"){
        setScreen("screenGame");
      }

      // Game header
      setText("gameRoomId", room.roomId);
      setText("gameMeRole", client.role || "—");
      if(room.status !== "playing") return;

      setText("p1Name", room.players.p1.name || "Player 1");
      setText("p2Name", room.players.p2.name || "Player 2");
      setText("p1Name2", room.players.p1.name || "Player 1");
      setText("p2Name2", room.players.p2.name || "Player 2");

      setModeUI(room);

      setText("p1Count", room.state.counts.p1 || 0);
      setText("p2Count", room.state.counts.p2 || 0);

      const nhieDone = room.state.nhieAnswered.p1 && room.state.nhieAnswered.p2;
      el("scoreP1").classList.toggle("active", room.mode==="nhie" && room.state.nhieTurn==="p1" && !nhieDone);
      el("scoreP2").classList.toggle("active", room.mode==="nhie" && room.state.nhieTurn==="p2" && !nhieDone);
      if(room.mode!=="nhie"){ el("scoreP1").classList.remove("active"); el("scoreP2").classList.remove("active"); }

      const item = getCurrentItem(room);
      const q = getQ(room);

      if(!item){
        setText("qText", "No questions yet.");
        setText("qMeta", "Open Manage → add questions");
        el("opt1Btn").textContent = "Option 1";
        el("opt2Btn").textContent = "Option 2";
        setProgress(room);
        updateNhieUI(room);
        updatePickUI(room);
        return;
      }

      if(room.mode === "nhie"){
        setText("qText", item);
        setText("qMeta", `Never Have I Ever • ${room.idx+1}/${(q.nhie||[]).length}`);
        setProgress(room);
        updateNhieUI(room);
      }else{
        const qq = item.q?.trim() ? item.q.trim() : "Pick one";
        setText("qText", qq);
        setText("qMeta", `Pick One • ${room.idx+1}/${(q.pick||[]).length}`);
        el("opt1Btn").textContent = item.o1 || "Option 1";
        el("opt2Btn").textContent = item.o2 || "Option 2";
        setProgress(room);
        updatePickUI(room);
      }

      el("next").disabled = !(client.role==="p1");
      el("reset").disabled = !(client.role==="p1");
    }

    // flows
    async function createRoomFlow(){
      showHomeError("");
      const myName = clampName(el("myNameCreate").value, "Player 1");
      try{
        const q = deepClone(questions);
        const { roomId, role } = await RoomAPI.createRoom({
          hostUid: client.uid,
          hostName: myName,
          q,
          session: client.session
        });
        client.role = role;
        client.roomId = roomId;
        setText("topSub", "Room created. Share link and wait for friend.");
        subscribeRoom(roomId);
      }catch(err){
        console.error(err);
        showHomeError(err?.message || "Failed to create room");
      }
    }

    async function joinRoomFlow(){
      showHomeError("");
      const raw = el("roomIdJoin").value || "";
      const myName = clampName(el("myNameJoin").value, "Player 2");
      const rid = extractRoomIdFromInput(raw);
      if(!rid) return showHomeError("Please enter Room code or paste full link.");
      try{
        const { role, roomId: realRid } = await RoomAPI.joinRoom({
          roomId: raw,
          uid: client.uid,
          name: myName,
          session: client.session
        });
        client.role = role;
        client.roomId = realRid;
        setText("topSub", "Joined room. Waiting for host to start.");
        subscribeRoom(realRid);
      }catch(err){
        console.error(err);
        showHomeError(err?.message || "Failed to join room");
      }
    }

    async function startGameFlow(){
      showLobbyError("");
      if(client.role !== "p1" || !client.roomId) return;
      try{
        const q = deepClone(questions);
        await RoomAPI.patchRoom(client.roomId, (doc) => {
          const both = doc.players.p1.uid && doc.players.p2.uid;
          if(!both) return doc;

          doc.questions = q;
          doc.status = "playing";
          doc.mode = doc.mode || "nhie";

          const len = doc.mode === "nhie" ? (q.nhie||[]).length : (q.pick||[]).length;
          doc.order = buildOrder(len);
          doc.idx = 0;

          doc.state.last = {p1:"—",p2:"—"};
          doc.state.nhieAnswered = {p1:false,p2:false};
          doc.state.nhieTurn = "p1";

          doc.state.pickLast = {p1:"—",p2:"—"};
          doc.state.pickAnswered = {p1:false,p2:false};
          doc.state.pickTurn = "p1";
          return doc;
        });
      }catch(err){
        console.error(err);
        showLobbyError(err?.message || "Cannot start");
      }
    }

    async function leaveRoomFlow(){
      try{
        if(client.roomId) await RoomAPI.leaveRoom(client.roomId, client.uid);
      }catch(e){ console.error(e); }
      cleanupRoom();
      setScreen("screenHome");
    }

    async function kickP2Flow(){
      try{
        if(!client.roomId) return;
        await RoomAPI.kickP2(client.roomId, client.uid);
      }catch(e){
        console.error(e);
        showLobbyError(e?.message || "Kick failed");
      }
    }

    async function setMode(mode){
      if(client.role !== "p1" || !client.roomId) return;
      await RoomAPI.patchRoom(client.roomId, (doc) => {
        doc.mode = mode;
        const q = doc.questions || {nhie:[], pick:[]};
        const len = mode === "nhie" ? (q.nhie||[]).length : (q.pick||[]).length;
        doc.order = buildOrder(len);
        doc.idx = 0;

        doc.state.last = {p1:"—",p2:"—"};
        doc.state.nhieAnswered = {p1:false,p2:false};
        doc.state.nhieTurn = "p1";

        doc.state.pickLast = {p1:"—",p2:"—"};
        doc.state.pickAnswered = {p1:false,p2:false};
        doc.state.pickTurn = "p1";
        return doc;
      });
    }

    async function nhieSelect(answerText){
      if(!client.roomId) return;
      await RoomAPI.patchRoom(client.roomId, (doc) => {
        if(doc.status !== "playing" || doc.mode !== "nhie") return doc;
        const turn = doc.state.nhieTurn;
        if(client.role !== turn) return doc;
        if(doc.state.nhieAnswered[turn]) return doc;

        doc.state.last[turn] = answerText;
        doc.state.nhieAnswered[turn] = true;
        if(answerText === "I Have"){
          doc.state.counts[turn] = (doc.state.counts[turn] || 0) + 1;
        }
        const other = (turn === "p1") ? "p2" : "p1";
        if(!doc.state.nhieAnswered[other]) doc.state.nhieTurn = other;
        return doc;
      });
    }

    async function pickSelect(optionText){
      if(!client.roomId) return;
      await RoomAPI.patchRoom(client.roomId, (doc) => {
        if(doc.status !== "playing" || doc.mode !== "pick") return doc;
        const turn = doc.state.pickTurn;
        if(client.role !== turn) return doc;
        if(doc.state.pickAnswered[turn]) return doc;

        doc.state.pickLast[turn] = optionText;
        doc.state.pickAnswered[turn] = true;
        const other = (turn === "p1") ? "p2" : "p1";
        if(!doc.state.pickAnswered[other]) doc.state.pickTurn = other;
        return doc;
      });
    }

    async function nextQuestion(){
      if(client.role !== "p1" || !client.roomId) return;
      await RoomAPI.patchRoom(client.roomId, (doc) => {
        if(doc.status !== "playing") return doc;

        const q = doc.questions || {nhie:[], pick:[]};
        const len = doc.mode === "nhie" ? (q.nhie||[]).length : (q.pick||[]).length;
        if(!len) return doc;

        if(doc.mode === "nhie"){
          if(!(doc.state.nhieAnswered.p1 && doc.state.nhieAnswered.p2)) return doc;
        }else{
          if(!(doc.state.pickAnswered.p1 && doc.state.pickAnswered.p2)) return doc;
        }

        doc.idx = (doc.idx + 1) % len;

        doc.state.last = {p1:"—",p2:"—"};
        doc.state.nhieAnswered = {p1:false,p2:false};
        doc.state.nhieTurn = "p1";

        doc.state.pickLast = {p1:"—",p2:"—"};
        doc.state.pickAnswered = {p1:false,p2:false};
        doc.state.pickTurn = "p1";
        return doc;
      });
    }

    async function resetGame(){
      if(client.role !== "p1" || !client.roomId) return;
      await RoomAPI.patchRoom(client.roomId, (doc) => {
        const q = doc.questions || {nhie:[], pick:[]};
        const len = doc.mode === "nhie" ? (q.nhie||[]).length : (q.pick||[]).length;

        doc.state.counts = {p1:0,p2:0};
        doc.idx = 0;
        doc.order = buildOrder(len);

        doc.state.last = {p1:"—",p2:"—"};
        doc.state.nhieAnswered = {p1:false,p2:false};
        doc.state.nhieTurn = "p1";

        doc.state.pickLast = {p1:"—",p2:"—"};
        doc.state.pickAnswered = {p1:false,p2:false};
        doc.state.pickTurn = "p1";
        return doc;
      });
    }

    // Manage UI
    function escapeHtml(s){
      return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function renderLists(){
      el("nhieList").innerHTML = questions.nhie.length
        ? questions.nhie.map((q,i)=>`
          <div class="listItem">
            <div>${escapeHtml(q)}</div>
            <button class="del" data-del-nhie="${i}">Delete</button>
          </div>
        `).join("")
        : `<div class="tiny">No NHIE questions.</div>`;

      el("pickList").innerHTML = questions.pick.length
        ? questions.pick.map((p,i)=>`
          <div class="listItem">
            <div><b>${escapeHtml(p.o1||"Option 1")}</b> vs <b>${escapeHtml(p.o2||"Option 2")}</b></div>
            <button class="del" data-del-pick="${i}">Delete</button>
          </div>
        `).join("")
        : `<div class="tiny">No Pick One questions.</div>`;
    }
    function openSheet(){
      el("overlay").classList.add("show");
      const unlocked = localStorage.getItem("admin_unlocked_firebase")==="1";
      el("adminLogin").style.display = unlocked ? "none" : "block";
      el("adminPanel").style.display = unlocked ? "block" : "none";
      if(unlocked) renderLists();
      el("adminPass").value = "";
      el("adminPass").setAttribute("readonly","readonly");
      setTimeout(()=>el("adminPass").blur(), 0);
    }
    function closeSheet(){ el("overlay").classList.remove("show"); }

    // Wire
    el("btnCreateRoom").addEventListener("click", createRoomFlow);
    el("btnJoinRoom").addEventListener("click", joinRoomFlow);
    el("startGame").addEventListener("click", startGameFlow);
    el("leaveRoom").addEventListener("click", leaveRoomFlow);
    el("kickP2").addEventListener("click", kickP2Flow);

    el("copyLink").addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(el("shareLink").value);
        el("copyLink").textContent = "Copied ✅";
        setTimeout(()=> el("copyLink").textContent = "Copy Link", 900);
      }catch{
        el("shareLink").select();
        document.execCommand("copy");
      }
    });

    el("tabNhie").addEventListener("click", ()=> setMode("nhie"));
    el("tabPick").addEventListener("click", ()=> setMode("pick"));
    el("nhieHave").addEventListener("click", ()=> nhieSelect("I Have"));
    el("nhieNever").addEventListener("click", ()=> nhieSelect("I Never"));
    el("opt1Btn").addEventListener("click", ()=> pickSelect(el("opt1Btn").textContent || "Option 1"));
    el("opt2Btn").addEventListener("click", ()=> pickSelect(el("opt2Btn").textContent || "Option 2"));
    el("next").addEventListener("click", nextQuestion);
    el("reset").addEventListener("click", resetGame);

    el("openAdmin").addEventListener("click", openSheet);
    el("closeSheet").addEventListener("click", closeSheet);

    el("adminPass").addEventListener("pointerdown", ()=> el("adminPass").removeAttribute("readonly"));
    el("adminPass").addEventListener("focus", ()=> el("adminPass").removeAttribute("readonly"));

    el("unlock").addEventListener("click", ()=>{
      const pass = (el("adminPass").value || "").trim();
      if(pass === ADMIN_PASSWORD){
        localStorage.setItem("admin_unlocked_firebase","1");
        el("adminLogin").style.display = "none";
        el("adminPanel").style.display = "block";
        renderLists();
      }else alert("Wrong password");
    });

    el("addNhie").addEventListener("click", ()=>{
      const v = (el("nhieNew").value || "").trim();
      if(!v) return;
      questions.nhie.unshift(v);
      el("nhieNew").value="";
      saveQuestions(); renderLists();
    });

    el("clearNhie").addEventListener("click", ()=>{
      if(!confirm("Clear all NHIE questions?")) return;
      questions.nhie = [];
      saveQuestions(); renderLists();
    });

    el("addPick").addEventListener("click", ()=>{
      const q = (el("pickQ").value || "").trim() || "Pick one";
      const o1 = (el("pickO1").value || "").trim();
      const o2 = (el("pickO2").value || "").trim();
      if(!o1 || !o2) return alert("Fill both options.");
      questions.pick.unshift({q,o1,o2});
      el("pickQ").value=""; el("pickO1").value=""; el("pickO2").value="";
      saveQuestions(); renderLists();
    });

    el("clearPick").addEventListener("click", ()=>{
      if(!confirm("Clear all Pick One questions?")) return;
      questions.pick = [];
      saveQuestions(); renderLists();
    });

    el("loadSample").addEventListener("click", ()=>{
      questions.nhie = deepClone(SAMPLE_Q.nhie);
      questions.pick = deepClone(SAMPLE_Q.pick);
      saveQuestions(); renderLists();
      alert("Sample loaded ✅");
    });

    el("wipeAll").addEventListener("click", ()=>{
      if(!confirm("Reset EVERYTHING?")) return;
      localStorage.removeItem(QKEY);
      localStorage.removeItem("admin_unlocked_firebase");
      localStorage.removeItem(SESSION_KEY);
      location.reload();
    });

    el("overlay").addEventListener("click", (e)=>{
      const dn = e.target?.getAttribute?.("data-del-nhie");
      const dp = e.target?.getAttribute?.("data-del-pick");
      if(dn != null){ questions.nhie.splice(Number(dn),1); saveQuestions(); renderLists(); }
      if(dp != null){ questions.pick.splice(Number(dp),1); saveQuestions(); renderLists(); }
    });

    function bootUI(){
      loadQuestions();
      setScreen("screenHome");
      const url = new URL(window.location.href);
      const roomFromUrl = cleanRoomId(url.searchParams.get("room") || "");
      if(roomFromUrl){
        el("roomIdJoin").value = roomFromUrl;
        setText("topSub", "Room link opened. Enter your name & Join.");
        setTimeout(()=> el("myNameJoin").focus(), 250);
      }
    }

    // Auth
    setPersistence(auth, browserLocalPersistence).then(()=> signInAnonymously(auth))
      .catch((e)=>{ console.error(e); showHomeError("Auth error: " + (e?.message || "unknown")); });

    onAuthStateChanged(auth, (user) => {
      if(!user) return;
      client.uid = user.uid;
      el("authInfo").textContent = "Connected (uid: " + user.uid.slice(0,8) + "…)";
      bootUI();
    });
  </script>
</body>
</html>
