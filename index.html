<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Private Room</title>

  <!-- âœ… Fix favicon 404 (optional but clean) -->
  <link rel="icon" href="data:," />

  <style>
    :root{
      /* âœ… Pinkish-Red Theme */
      --bg:#fff1f6;            /* pink-50 */
      --card:#ffffff;
      --stroke:#ffd1e1;        /* soft pink stroke */
      --blue:#db2777;          /* pink-600 */
      --blue2:#ef4444;         /* red-500 */
      --txt:#0f172a;
      --muted:#6b7280;
      --shadow: 0 10px 26px rgba(15,23,42,.08);
      --r:18px;

      /* âœ… Extra accents */
      --tdSel:#2563eb;         /* BLUE for selected card */
      --tdSel2:#60a5fa;

      /* âœ… Chat */
      --chatMe:#fce7f3;        /* pink-100 */
      --chatOther:#ffffff;
      --chatStroke:#ffd1e1;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{
      margin:0; min-height:100dvh;
      background:
        radial-gradient(1100px 520px at 50% -25%, rgba(219,39,119,.22), transparent 55%),
        radial-gradient(700px 380px at 0% 0%, rgba(239,68,68,.12), transparent 60%),
        linear-gradient(180deg,var(--bg),#fff);
      color:var(--txt);
      display:flex; justify-content:center; align-items:flex-start;
      padding:14px;
    }
    .app{width:min(520px,100%);display:grid;gap:12px;padding-bottom:96px}

    /* âœ… TOPBAR tighter */
    .topbar{
      background:rgba(255,255,255,.92);
      border:1px solid var(--stroke);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:4px 6px;               /* tighter */
      backdrop-filter: blur(10px);
    }
    .titleRow{
      display:flex;
      justify-content:space-between;
      align-items:center;            /* âœ… Manage button perfectly aligned right of logo row */
      gap:10px;
    }

    /* âœ… Logo crop wrapper (removes top/bottom whitespace from PNG visually) */
    .logoClip{
      height:118px;                  /* âœ… reduce white space above/below */
      overflow:hidden;
      display:flex;
      align-items:center;
    }
    .topLogo{
      height:165px;                  /* KEEP SAME IMAGE HEIGHT */
      width:auto;
      display:block;
      object-fit:contain;
      transform: translateY(-18px) scale(1.06); /* âœ… crop top/bottom whitespace */
      transform-origin:center;
    }

    h1{margin:0;font-size:16px;letter-spacing:.2px}
    .sub{margin-top:4px;color:var(--muted);font-size:12px;line-height:1.3}

    .seg{
      display:flex;gap:8px;margin-top:6px;
      background:linear-gradient(180deg,#ffe4ee,#fff5f8);
      padding:6px;border-radius:999px;border:1px solid var(--stroke)
    }
    .seg button{
      flex:1;border:0;border-radius:999px;padding:10px;cursor:pointer;background:transparent;
      color:var(--muted);font-weight:1000;letter-spacing:.2px;
      position:relative;
    }
    .seg button.active{
      background:linear-gradient(135deg,var(--blue),var(--blue2));
      color:#fff;box-shadow:0 10px 20px rgba(219,39,119,.22)
    }

    /* âœ… chat bell notification */
    .bellBadge{
      position:absolute; right:10px; top:8px;
      width:10px;height:10px;border-radius:50%;
      background:#ef4444;
      border:2px solid rgba(255,255,255,.95);
      display:none;
      box-shadow:0 10px 20px rgba(239,68,68,.25);
    }
    .seg button.hasBell .bellBadge{display:block;}

    .card{
      background:rgba(255,255,255,.92);
      border:1px solid var(--stroke);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:12px;
      backdrop-filter: blur(10px);
      overflow:hidden;
    }

    .qBox{
      border:1px dashed #f7b3cf;
      background:linear-gradient(180deg,#fff7fb,#ffffff);
      border-radius:16px;
      padding:14px;
      min-height:110px;
      display:flex;flex-direction:column;justify-content:center;gap:8px;
      position:relative;
    }
    .qText{font-size:18px;font-weight:1000;line-height:1.25}
    .qMeta{font-size:12px;color:var(--muted);display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center}

    .prog{
      height:8px;border-radius:999px;background:#ffe8f1;border:1px solid var(--stroke);
      overflow:hidden; flex:1; min-width:140px;
    }
    .prog > i{
      display:block;height:100%;
      width:0%;
      background:linear-gradient(135deg,var(--blue),var(--blue2));
      border-radius:999px;
      box-shadow:0 10px 22px rgba(219,39,119,.20);
      transition:width .25s ease;
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    .btn{
      border:1px solid var(--stroke);
      background:linear-gradient(180deg,#ffffff,#fff7fb);
      color:var(--txt);
      border-radius:16px;
      padding:12px 12px;
      font-weight:1000;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(15,23,42,.06);
      transition:transform .06s ease, box-shadow .12s ease, filter .12s ease;
      user-select:none;
      position:relative;
      overflow:hidden;
      white-space:nowrap;
    }
    .btn:hover{filter:brightness(1.02)}
    .btn:active{transform:scale(.99)}
    .btn:disabled{opacity:.45; cursor:not-allowed; transform:none}
    .btn::after{
      content:"";
      position:absolute; inset:-60% -30% auto -30%;
      height:120%; transform:rotate(20deg);
      background:linear-gradient(90deg, transparent, rgba(255,255,255,.45), transparent);
      opacity:.0;
      transition:opacity .18s ease;
    }
    .btn:hover::after{opacity:.55}
    .btn.selected{
      background:linear-gradient(135deg,var(--blue),var(--blue2));
      color:#fff;border:0;
      box-shadow:0 14px 30px rgba(219,39,119,.26);
    }
    .btn.selected::after{opacity:.22}
    .btn.ghost{background:linear-gradient(180deg,#ffeaf2,#ffffff)}
    .btn.danger{
      background:linear-gradient(180deg,#fff5f7,#ffffff);
      border:1px solid #ffd2da;color:#b91c1c
    }

    .pill{
      font-size:12px;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(219,39,119,.20);
      background:rgba(219,39,119,.10);
      color:#9d174d;
      font-weight:1000
    }

    input, select{
      width:100%;
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:12px;
      background:#fff;
      outline:none;
      box-shadow:0 6px 14px rgba(15,23,42,.04);
    }
    select{cursor:pointer}

    .bottomBar{
      position:fixed;left:0;right:0;bottom:0;
      background:rgba(255,255,255,.9);
      backdrop-filter: blur(10px);
      border-top:1px solid var(--stroke);
      padding:10px;
      padding-bottom: calc(10px + env(safe-area-inset-bottom));
      display:flex;justify-content:center
    }
    .bottomInner{width:min(520px,100%);display:flex;gap:10px}
    .bottomInner .btn{flex:1}

    .overlay{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:flex-end;justify-content:center;padding:14px}
    .overlay.show{display:flex}
    .sheet{
      width:min(520px,100%);
      background:rgba(255,255,255,.96);
      border-radius:20px;
      border:1px solid var(--stroke);
      box-shadow:0 18px 55px rgba(0,0,0,.25);
      padding:12px;
      max-height:82vh;
      overflow:auto;
      backdrop-filter: blur(12px);
    }
    .sheetTop{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .sheetTitle{font-weight:1000}
    .xbtn{border:1px solid var(--stroke);background:#fff;border-radius:14px;padding:10px 12px;cursor:pointer;font-weight:1000}
    .hint{font-size:12px;color:var(--muted);margin:8px 0 10px;line-height:1.35}
    .divider{height:1px;background:#ffe3ef;margin:12px 0}
    .grid{display:grid;gap:10px}
    .miniRow{display:flex;gap:10px}
    .miniRow > *{flex:1}
    .list{margin-top:10px;border:1px solid var(--stroke);border-radius:16px;padding:10px;background:#fff7fb}
    .listItem{display:flex;justify-content:space-between;gap:10px;padding:10px;border-radius:14px;background:#fff;border:1px solid var(--stroke);margin-bottom:8px;font-size:13px;align-items:flex-start}
    .listItem:last-child{margin-bottom:0}
    .del{border:1px solid #ffd2da;background:#fff5f7;color:#b91c1c;border-radius:14px;padding:8px 10px;cursor:pointer;font-weight:1000;white-space:nowrap}
    .tiny{font-size:12px;color:var(--muted)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    .scoreGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .scoreCard{
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:12px;
      background:linear-gradient(180deg,#ffffff,#fff7fb);
      box-shadow:0 10px 22px rgba(15,23,42,.06);
      position:relative;
      overflow:hidden;
      transition:transform .10s ease, box-shadow .12s ease;
    }
    .scoreTop{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
    .scoreName{font-weight:1000;font-size:13px}
    .scoreNum{font-size:32px;font-weight:1000;color:var(--blue);line-height:1}
    .scoreCard.active{
      transform:translateY(-1px);
      box-shadow:0 16px 36px rgba(219,39,119,.14);
      border-color:rgba(219,39,119,.35);
    }
    .scoreCard.active::before{
      content:"";
      position:absolute; inset:0;
      background:radial-gradient(280px 140px at 20% 0%, rgba(219,39,119,.18), transparent 60%);
      pointer-events:none;
    }

    .nhieSelectedGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .selCard{
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:12px;
      background:linear-gradient(180deg,#ffffff,#fff7fb);
      box-shadow:0 8px 18px rgba(15,23,42,.05);
      display:grid; gap:8px;
    }
    .selHeader{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .selMini{font-size:12px;color:var(--muted);font-weight:900}
    .selBadge{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--stroke); background:#fff;
      font-weight:1000; color:var(--muted);
    }
    .selBadge.done{
      border:1px solid rgba(219,39,119,.25);
      background:rgba(219,39,119,.10);
      color:#9d174d;
    }
    .selValue{
      font-size:16px;font-weight:1000;line-height:1.2;
      padding:12px 12px;border-radius:14px;
      border:1px solid var(--stroke); background:#fff;
    }
    .selValue.selected{
      border:1px solid rgba(219,39,119,.25);
      background:rgba(219,39,119,.10);
      color:#9d174d;
    }

    .actionBoard{
      margin-top:10px;border:1px solid var(--stroke);
      border-radius:18px;padding:12px;
      background:linear-gradient(180deg,#ffffff,#fff5f9);
      display:grid; gap:10px;
    }
    .actionHeader{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .status{font-size:12px;color:var(--muted)}
    .bigRow{display:flex;gap:10px}
    .bigRow .btn{flex:1;padding:14px;border-radius:18px;font-size:14px}

    .pickSelectedGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .pickSelCard{
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:12px;
      background:linear-gradient(180deg,#ffffff,#fff7fb);
      box-shadow:0 8px 18px rgba(15,23,42,.05);
    }
    .pickSelName{font-weight:1000;font-size:13px}
    .pickSelValue{
      margin-top:8px;font-size:18px;font-weight:1000;line-height:1.2;
      padding:12px 12px;border-radius:14px;border:1px solid var(--stroke);background:#fff;
    }
    .pickSelValue.selected{
      border:1px solid rgba(219,39,119,.25);
      background:rgba(219,39,119,.10);
      color:#9d174d;
    }

    /* âœ… Truth/Dare UI */
    .tdBoard{
      margin-top:10px;border:1px solid var(--stroke);
      border-radius:18px;padding:12px;
      background:linear-gradient(180deg,#ffffff,#fff5f9);
      display:grid; gap:10px;
    }
    .tdTop{
      display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;
    }
    .tdWho{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .cardsGrid{display:grid;grid-template-columns:1fr;gap:10px;}

    .cardBtn{
      text-align:left;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background:#fff;
      box-shadow:0 8px 18px rgba(15,23,42,.05);
      cursor:pointer;
      font-weight:1000;
      line-height:1.25;
      position:relative;
      overflow:hidden;
    }
    .cardBtn:hover{filter:brightness(1.01)}
    .cardBtn:disabled{opacity:.70; cursor:not-allowed}

    /* âœ… BLUE selected for both players */
    .cardBtn.selected{
      background:linear-gradient(135deg,var(--tdSel),var(--tdSel2));
      border-color:rgba(37,99,235,.35);
      color:#fff;
      box-shadow:0 14px 30px rgba(37,99,235,.18);
    }
    .cardBtn.selected::after{
      content:"";
      position:absolute; inset:-40% -30% auto -30%;
      height:120%; transform:rotate(18deg);
      background:linear-gradient(90deg, transparent, rgba(255,255,255,.38), transparent);
      opacity:.65;
      pointer-events:none;
    }

    /* =========================
       âœ… Wheel (unchanged)
       ========================= */
    .wheelWrap{display:grid;place-items:center;gap:10px;padding:6px 0 2px;}
    .wheelStage{position:relative;width:264px;height:264px;display:grid;place-items:center;}
    .wheelGlow{position:absolute; inset:-12px;border-radius:50%;background:radial-gradient(closest-side, rgba(255,255,255,.55), transparent 60%);filter:blur(2px);opacity:.85;pointer-events:none;}
    .wheelPointer{position:absolute;top:-12px; left:50%;transform:translateX(-50%);width:0;height:0;border-left:16px solid transparent;border-right:16px solid transparent;border-bottom:34px solid #ffffff;filter:drop-shadow(0 12px 16px rgba(15,23,42,.20));z-index:6;}
    .wheelPointer::after{content:"";position:absolute;left:-12px; top:8px;width:24px;height:24px;border-radius:50%;background:linear-gradient(135deg,var(--blue),var(--blue2));border:2px solid #fff;box-shadow:0 10px 18px rgba(219,39,119,.22);}
    .wheel{
      width:252px;height:252px;border-radius:50%;
      border:10px solid #fff;
      outline:2px solid rgba(15,23,42,.12);
      box-shadow:0 26px 60px rgba(15,23,42,.12),0 16px 36px rgba(219,39,119,.16);
      background:conic-gradient(from -90deg,#22c55e 0deg 45deg,#f59e0b 45deg 90deg,#ef4444 90deg 135deg,#ec4899 135deg 180deg,#a855f7 180deg 225deg,#3b82f6 225deg 270deg,#06b6d4 270deg 315deg,#10b981 315deg 360deg);
      position:relative;
      transform:rotate(0deg);
      transition:transform 2.6s cubic-bezier(.12,.85,.22,1);
      overflow:hidden;
      z-index:2;
    }
    .wheel::before{
      content:"";position:absolute; inset:0;border-radius:50%;
      background:
        repeating-conic-gradient(from -90deg,rgba(255,255,255,.55) 0deg 1.2deg,rgba(255,255,255,0) 1.2deg 45deg),
        radial-gradient(130px 110px at 30% 25%, rgba(255,255,255,.35), transparent 60%),
        radial-gradient(160px 130px at 70% 75%, rgba(255,255,255,.22), transparent 65%);
      mix-blend-mode:overlay;
      pointer-events:none;
    }
    .wheel::after{
      content:"";position:absolute; inset:12px;border-radius:50%;
      background:radial-gradient(closest-side, rgba(255,255,255,.25), transparent 62%),radial-gradient(closest-side, rgba(0,0,0,.06), transparent 70%);
      pointer-events:none;
    }
    .wheelText{position:absolute;inset:0;pointer-events:none;z-index:3;}
    .wheelText .lbl{
      position:absolute;left:50%;top:50%;width:120px;transform-origin:0 0;
      font-weight:1000;letter-spacing:.8px;text-transform:uppercase;font-size:12px;color:#fff;
      text-shadow:0 10px 26px rgba(15,23,42,.32);
      display:flex;justify-content:flex-start;align-items:center;gap:6px;
    }
    .wheelText .lbl span{
      display:inline-block;padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.22);backdrop-filter: blur(6px);
    }
    .wheelText .lbl.dare span{background:rgba(0,0,0,.18);border:1px solid rgba(0,0,0,.18);}
    .wheelSpinBtn{
      position:absolute;width:92px;height:92px;border-radius:50%;
      border:10px solid #fff;outline:2px solid rgba(15,23,42,.12);
      background:linear-gradient(135deg,var(--blue),var(--blue2));
      color:#fff;font-weight:1000;letter-spacing:1px;
      box-shadow:0 18px 40px rgba(15,23,42,.16), 0 14px 30px rgba(219,39,119,.18);
      cursor:pointer;z-index:7;display:grid;place-items:center;user-select:none;
    }
    .wheelSpinBtn:active{transform:scale(.99)}
    .wheelSpinBtn:disabled{opacity:.55; cursor:not-allowed; transform:none}
    .wheelSpinBtn small{display:block;font-size:10px;opacity:.9;letter-spacing:.6px;margin-top:2px;font-weight:900;}

    .tdBadge{
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      padding:10px 14px;border-radius:999px;font-weight:1000;letter-spacing:.8px;text-transform:uppercase;
      border:1px solid rgba(219,39,119,.25);background:rgba(255,255,255,.75);
      box-shadow:0 10px 22px rgba(15,23,42,.06);
      width:fit-content;margin:0 auto;
    }
    .tdBadge.big{font-size:16px;padding:12px 18px;}
    .tdBadge.truth{background:rgba(219,39,119,.12);color:#9d174d;}
    .tdBadge.dare{background:rgba(239,68,68,.10);color:#b91c1c;}

    .tdChosenBox{
      border:1px solid rgba(37,99,235,.22);
      background:linear-gradient(180deg, rgba(37,99,235,.08), rgba(255,255,255,.92));
      border-radius:18px;
      padding:12px;
      box-shadow:0 12px 26px rgba(37,99,235,.08);
      display:none;
    }
    .tdChosenTop{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:8px;}
    .tdChosenTitle{font-weight:1000;color:#1d4ed8;display:flex;align-items:center;gap:8px;}
    .tdChosenText{
      font-size:16px;font-weight:1000;line-height:1.25;color:var(--txt);
      padding:10px 12px;border-radius:14px;background:#fff;border:1px solid rgba(37,99,235,.18);
    }

    .screen{display:none}
    .screen.show{display:block}

    .roomCard{
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:12px;
      background:linear-gradient(180deg,#ffffff,#fff7fb);
      box-shadow:0 10px 22px rgba(15,23,42,.06);
      display:grid; gap:10px;
    }
    .roomTitle{font-weight:1000}
    .roomLine{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .copyRow{display:flex;gap:10px}
    .copyRow .btn{flex:0 0 auto; padding:10px 12px}
    .copyRow input{flex:1}
    .centerNote{font-size:12px;color:var(--muted);line-height:1.35}

    /* âœ… Avatar UI (male/female) */
    .pRow{display:flex;align-items:center;gap:10px}
    .av{
      width:28px;height:28px;border-radius:50%;
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
      box-shadow:0 10px 20px rgba(15,23,42,.08);
      object-fit:cover;
      flex:0 0 auto;
    }
    .av.lg{width:34px;height:34px}
    .nameWrap{display:grid;gap:2px}
    .roleTiny{font-size:11px;color:var(--muted);font-weight:900;letter-spacing:.2px}

    /* âœ… Chat */
    .chatShell{
      border:1px solid var(--stroke);
      border-radius:18px;
      background:linear-gradient(180deg,#ffffff,#fff7fb);
      box-shadow:0 10px 22px rgba(15,23,42,.06);
      overflow:hidden;
      margin-top:10px;
    }
    .chatHead{
      padding:10px 12px;
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      border-bottom:1px solid #ffe3ef;
      background:rgba(255,255,255,.75);
    }
    /* âœ… Chat header now shows ONLY other person (name+icon) */
    .chatTitle{
      font-weight:1000;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .chatMsgs{
      padding:12px;
      max-height:360px;
      overflow:auto;
      display:grid; gap:10px;
      background:linear-gradient(180deg,#fff,#fff7fb);
    }
    .bubbleRow{display:flex;gap:10px;align-items:flex-end}
    .bubbleRow.me{justify-content:flex-end}
    .bubble{
      max-width:78%;
      border:1px solid var(--chatStroke);
      border-radius:16px;
      padding:10px 12px;
      background:var(--chatOther);
      font-size:13px;
      line-height:1.35;
      box-shadow:0 10px 22px rgba(15,23,42,.06);
    }
    .bubble.me{
      background:var(--chatMe);
      border-color:rgba(219,39,119,.20);
    }
    .bTime{
      font-size:11px;color:var(--muted);white-space:nowrap;
      margin-top:6px;text-align:right;
    }

    .chatSend{
      padding:10px 12px;
      border-top:1px solid #ffe3ef;
      display:flex;gap:10px;
      background:rgba(255,255,255,.75);
      align-items:center;
    }
    .chatSend input{flex:1}

    /* âœ… image in chat */
    .imgWrap{
      margin-top:6px;
      border:1px solid rgba(15,23,42,.08);
      border-radius:14px;
      overflow:hidden;
      background:#fff;
    }
    .imgWrap img{width:100%;display:block;}
    .imgHint{font-size:11px;color:var(--muted);margin-top:6px}

    /* âœ… Custom uploaded image icon button (42x42 + 24px icon) */
    .iconBtn{
      width:42px;height:42px;
      padding:0;
      display:grid;place-items:center;
      border-radius:16px;
    }
    .iconBtn img{
      width:24px;height:24px;display:block;
      filter: drop-shadow(0 6px 10px rgba(15,23,42,.10));
    }
  </style>
</head>
<body>
  <div class="app">

    <div class="topbar">
      <div class="titleRow">
        <div class="logoClip">
          <img class="topLogo" src="assets/3003fd67-ad54-4e2e-a90e-bcb16878ae97.png" alt="Private Room logo" />
        </div>
        <button class="btn ghost" id="openAdmin">Manage</button>
      </div>

      <!-- âœ… keep element but hide when empty -->
      <div class="sub" id="topSub" style="display:none;"></div>

      <!-- âœ… Tabs: Chat first. Game tabs after. -->
      <div class="seg" id="modeSeg" style="display:none;">
        <button id="tabChat">
          ðŸ”” Chat
          <span class="bellBadge" id="chatBell" aria-hidden="true"></span>
        </button>
        <button id="tabNhie" class="">Never Have I Ever</button>
        <button id="tabPick">Pick One</button>
        <button id="tabTD">Truth / Dare</button>
      </div>
    </div>

    <!-- HOME -->
    <div class="card screen show" id="screenHome">
      <div class="roomCard">
        <div class="roomTitle">Play with a friend (real-time)</div>
        <div class="centerNote">
          Create room â†’ share link â†’ friend joins â†’ host starts â†’ live sync.
        </div>

        <div class="divider"></div>

        <div class="grid">
          <div class="hint"><b>Create Room</b></div>

          <!-- âœ… Name + Gender -->
          <div class="miniRow">
            <input id="myNameCreate" placeholder="Your name" />
            <select id="myGenderCreate" aria-label="Gender">
              <option value="male">Male</option>
              <option value="female">Female</option>
            </select>
          </div>

          <button class="btn selected" id="btnCreateRoom">Create Room</button>
        </div>

        <div class="divider"></div>

        <div class="grid">
          <div class="hint"><b>Join Room</b></div>

          <input id="roomIdJoin" placeholder="Room code (e.g. AB12CD)" />

          <!-- âœ… Name + Gender -->
          <div class="miniRow">
            <input id="myNameJoin" placeholder="Your name" />
            <select id="myGenderJoin" aria-label="Gender">
              <option value="male">Male</option>
              <option value="female">Female</option>
            </select>
          </div>

          <button class="btn" id="btnJoinRoom">Join Room</button>
        </div>

        <div class="tiny" id="homeErr" style="display:none;color:#b91c1c;font-weight:900;"></div>
        <div class="tiny" id="authInfo" style="margin-top:6px;"></div>
      </div>
    </div>

    <!-- LOBBY -->
    <div class="card screen" id="screenLobby">
      <div class="roomCard">
        <div class="roomTitle">Room Lobby</div>

        <div class="roomLine">
          <span class="pill">Room</span>
          <span class="mono" id="lobbyRoomId">â€”</span>
          <span class="pill" id="lobbyRolePill">Role: â€”</span>
        </div>

        <div class="copyRow">
          <input id="shareLink" readonly />
          <button class="btn selected" id="copyLink">Copy Link</button>
        </div>

        <div class="divider"></div>

        <div class="grid">
          <div class="hint">Players</div>
          <div class="scoreGrid">
            <div class="scoreCard">
              <div class="scoreTop">
                <div class="pRow">
                  <img class="av lg" id="lobbyP1Av" alt="P1 avatar" />
                  <div class="nameWrap">
                    <div class="scoreName" id="lobbyP1">Waitingâ€¦</div>
                    <div class="roleTiny">P1</div>
                  </div>
                </div>
                <div class="pill">P1</div>
              </div>
            </div>
            <div class="scoreCard">
              <div class="scoreTop">
                <div class="pRow">
                  <img class="av lg" id="lobbyP2Av" alt="P2 avatar" />
                  <div class="nameWrap">
                    <div class="scoreName" id="lobbyP2">Waitingâ€¦</div>
                    <div class="roleTiny">P2</div>
                  </div>
                </div>
                <div class="pill">P2</div>
              </div>
            </div>
          </div>
          <div class="centerNote" id="lobbyHint">Waiting for Player 2 to joinâ€¦</div>
        </div>

        <div class="row" style="justify-content:space-between">
          <button class="btn danger" id="leaveRoom">Leave</button>
          <button class="btn selected" id="startGame" disabled>Start</button>
        </div>

        <div class="tiny" id="lobbyErr" style="display:none;color:#b91c1c;font-weight:900;"></div>
      </div>
    </div>

    <!-- GAME -->
    <div class="card screen" id="screenGame">

      <!-- âœ… Everything below is "game section" (will be hidden in Chat tab) -->
      <div id="gameOnly">
        <div class="qBox">
          <div class="qText" id="qText">Loadingâ€¦</div>
          <div class="qMeta">
            <span id="qMeta">â€”</span>
            <div class="prog" aria-hidden="true"><i id="progFill"></i></div>
          </div>
        </div>

        <!-- NHIE -->
        <div id="nhieArea">
          <div class="scoreGrid">
            <div class="scoreCard" id="scoreP1">
              <div class="scoreTop">
                <div class="pRow">
                  <img class="av" id="p1Av" alt="P1 avatar" />
                  <div class="nameWrap">
                    <div class="scoreName" id="p1Name">Player 1</div>
                    <div class="roleTiny">P1</div>
                  </div>
                </div>
                <div class="scoreNum" id="p1Count">0</div>
              </div>
            </div>
            <div class="scoreCard" id="scoreP2">
              <div class="scoreTop">
                <div class="pRow">
                  <img class="av" id="p2Av" alt="P2 avatar" />
                  <div class="nameWrap">
                    <div class="scoreName" id="p2Name">Player 2</div>
                    <div class="roleTiny">P2</div>
                  </div>
                </div>
                <div class="scoreNum" id="p2Count">0</div>
              </div>
            </div>
          </div>

          <div class="nhieSelectedGrid">
            <div class="selCard">
              <div class="selHeader">
                <div class="selMini" id="p1SelMini">Player 1 â€¢ Selection</div>
                <span class="selBadge" id="p1Badge">Pending</span>
              </div>
              <div class="selValue" id="p1SelBox">â€”</div>
            </div>

            <div class="selCard">
              <div class="selHeader">
                <div class="selMini" id="p2SelMini">Player 2 â€¢ Selection</div>
                <span class="selBadge" id="p2Badge">Pending</span>
              </div>
              <div class="selValue" id="p2SelBox">â€”</div>
            </div>
          </div>

          <div class="actionBoard">
            <div class="actionHeader">
              <span class="pill" id="nhieTurnPill">Turn: â€”</span>
              <span class="status" id="nhieStatus">Select your answer.</span>
            </div>
            <div class="bigRow">
              <button class="btn" id="nhieHave">I Have</button>
              <button class="btn" id="nhieNever">I Never</button>
            </div>
          </div>
        </div>

        <!-- PICK -->
        <div id="pickArea" style="display:none; margin-top:10px;">
          <div class="row" style="justify-content:space-between; align-items:center;">
            <span class="pill" id="pickTurnPill">Turn: â€”</span>
            <span class="tiny" id="pickStatus">Select an option.</span>
          </div>

          <div class="row" style="margin-top:10px;">
            <button class="btn" id="opt1Btn" style="flex:1;">Option 1</button>
            <button class="btn" id="opt2Btn" style="flex:1;">Option 2</button>
          </div>

          <div class="pickSelectedGrid">
            <div class="pickSelCard">
              <div class="pickSelName" id="p1Name2">Player 1</div>
              <div class="pickSelValue" id="p1PickBox">â€”</div>
            </div>
            <div class="pickSelCard">
              <div class="pickSelName" id="p2Name2">Player 2</div>
              <div class="pickSelValue" id="p2PickBox">â€”</div>
            </div>
          </div>

          <div class="tiny" style="margin-top:8px;">Pick One has no score. Only selections are shown.</div>
        </div>

        <!-- TRUTH / DARE -->
        <div id="tdArea" style="display:none; margin-top:10px;">
          <div class="tdBoard">
            <div class="tdTop">
              <div class="tdWho">
                <span class="pill" id="tdTurnPill">Turn: â€”</span>
                <span class="pill" id="tdPhasePill">Phase: â€”</span>
              </div>
              <div class="row" style="gap:8px">
                <button class="btn selected" id="tdSpinBtn">ðŸŽ¡ Spin</button>
                <button class="btn" id="tdShuffleBtn">ðŸ”€ Shuffle</button>
                <button class="btn ghost" id="tdNextBtn">Next Spin</button>
              </div>
            </div>

            <div class="tdBadge big" id="tdResultBadge">â€”</div>

            <div class="wheelWrap">
              <div class="wheelStage">
                <div class="wheelGlow" aria-hidden="true"></div>
                <div class="wheelPointer" aria-hidden="true"></div>

                <div class="wheel" id="wheel">
                  <div class="wheelText" id="wheelText" aria-hidden="true"></div>
                </div>

                <button class="wheelSpinBtn" id="wheelSpinBtn">
                  SPIN
                  <small>tap</small>
                </button>
              </div>
              <div class="tiny" id="tdHint">â€”</div>
            </div>

            <div class="cardsGrid" id="tdCards"></div>

            <div class="tdChosenBox" id="tdChosenBox">
              <div class="tdChosenTop">
                <div class="tdChosenTitle">âœ… Selected</div>
                <div class="tiny" id="tdChosenMeta">â€”</div>
              </div>
              <div class="tdChosenText" id="tdChosenText">â€”</div>
            </div>
          </div>
        </div>

        <div class="tiny" id="gameFooter" style="margin-top:10px;">
          Room: <span class="mono" id="gameRoomId">â€”</span> â€¢ You are: <span class="mono" id="gameMeRole">â€”</span>
        </div>
      </div>

      <!-- âœ… CHAT -->
      <div id="chatArea" style="display:none; margin-top:10px;">
        <div class="chatShell">
          <div class="chatHead">
            <div class="chatTitle" id="chatTitleNames">â€”</div>
          </div>

          <div class="chatMsgs" id="chatMsgs"></div>

          <div class="chatSend">
            <input id="chatInput" placeholder="Type a messageâ€¦" maxlength="220"/>
            <input id="chatFile" type="file" accept="image/*" style="display:none" />

            <button class="btn iconBtn" id="chatImgBtn" title="Send image" aria-label="Send image">
              <img alt="image" src="assets/a0dae1fa-ca14-4604-8919-fa9e3577ea25.png" />
            </button>

            <button class="btn selected" id="chatSendBtn">Send</button>
          </div>
          <div class="imgHint tiny" id="chatErr" style="display:none;color:#b91c1c;font-weight:900;padding:0 12px 10px;"></div>
        </div>
      </div>

    </div>

  </div>

  <div class="bottomBar" id="bottomBar">
    <div class="bottomInner">
      <button class="btn ghost" id="reset">Reset</button>
      <button class="btn selected" id="next">Next</button>
    </div>
  </div>

  <!-- Manage Sheet -->
  <div class="overlay" id="overlay">
    <div class="sheet">
      <div class="sheetTop">
        <div class="sheetTitle">Manage</div>
        <button class="xbtn" id="closeSheet">âœ•</button>
      </div>

      <div id="adminLogin">
        <div class="hint">Password required</div>

        <form autocomplete="off" onsubmit="return false;">
          <input type="text" style="display:none" autocomplete="username">
          <input type="password" style="display:none" autocomplete="new-password">

          <div class="row">
            <input id="adminPass"
                   type="password"
                   placeholder="Password"
                   name="admin_pass__no_fill"
                   autocomplete="new-password"
                   inputmode="text"
                   autocapitalize="none"
                   autocorrect="off"
                   spellcheck="false"
                   data-lpignore="true"
                   data-1p-ignore="true"
                   readonly />
            <button class="btn selected" id="unlock" type="button">Unlock</button>
          </div>
        </form>
      </div>

      <div id="adminPanel" style="display:none;">
        <div class="hint">Manage questions here (saved on this phone).</div>

        <div class="divider"></div>
        <div class="grid">
          <div class="hint"><b>Order settings</b></div>

          <label class="listItem" style="align-items:center;">
            <div>
              <div style="font-weight:1000;">Shuffle Never Have I Ever</div>
              <div class="tiny">ON = random order â€¢ OFF = normal order</div>
            </div>
            <input type="checkbox" id="shuffleNhie" checked style="width:auto; transform:scale(1.2);" />
          </label>

          <label class="listItem" style="align-items:center;">
            <div>
              <div style="font-weight:1000;">Shuffle Pick One</div>
              <div class="tiny">ON = random order â€¢ OFF = normal order</div>
            </div>
            <input type="checkbox" id="shufflePick" checked style="width:auto; transform:scale(1.2);" />
          </label>

          <div class="tiny">Note: Shuffle applies on Create Room / Start / Reset / Mode switch.</div>
        </div>

        <div class="divider"></div>

        <div class="grid">
          <div class="hint"><b>Never Have I Ever</b> â€“ Add one question:</div>
          <input id="nhieNew" placeholder="e.g. Never have I ever skipped class"/>
          <div class="row">
            <button class="btn selected" id="addNhie">Add</button>
            <button class="btn danger" id="clearNhie">Clear All</button>
          </div>
          <div class="list" id="nhieList"></div>
        </div>

        <div class="divider"></div>

        <div class="grid">
          <div class="hint"><b>Pick One</b> â€“ Easy add:</div>
          <input id="pickQ" placeholder="Question (optional) e.g. Pick one"/>
          <div class="miniRow">
            <input id="pickO1" placeholder="Option 1"/>
            <input id="pickO2" placeholder="Option 2"/>
          </div>
          <div class="row">
            <button class="btn selected" id="addPick">Add</button>
            <button class="btn danger" id="clearPick">Clear All</button>
          </div>
          <div class="list" id="pickList"></div>
        </div>

        <div class="divider"></div>
        <div class="grid">
          <div class="hint"><b>Truth</b> â€“ Add unlimited:</div>
          <input id="truthNew" placeholder="e.g. Whatâ€™s your biggest fear?" />
          <div class="row">
            <button class="btn selected" id="addTruth">Add</button>
            <button class="btn danger" id="clearTruth">Clear All</button>
          </div>
          <div class="list" id="truthList"></div>
        </div>

        <div class="divider"></div>
        <div class="grid">
          <div class="hint"><b>Dare</b> â€“ Add unlimited:</div>
          <input id="dareNew" placeholder="e.g. Do 10 push-ups right now" />
          <div class="row">
            <button class="btn selected" id="addDare">Add</button>
            <button class="btn danger" id="clearDare">Clear All</button>
          </div>
          <div class="list" id="dareList"></div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <button class="btn ghost" id="loadSample">Load Sample</button>
          <button class="btn danger" id="wipeAll">Reset Everything</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // ===========================
    // âœ… SUPABASE CONFIG
    // ===========================
    const SUPABASE_URL = "https://xgiryhgysebcskkyhmej.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_7WgNVc5MkpgJcoCj3iQArw_J4zcgtsg";

    const CHAT_IMG_BUCKET = "chat-media";
    const MAX_IMAGE_BYTES = 4 * 1024 * 1024; // 4MB

    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });

    // ===========================
    // âœ… Gender icons
    // ===========================
    const ICONS = {
      male: "",
      female: ""
    };

    // ---------------------------
    // Utilities
    // ---------------------------
    const el = (id) => document.getElementById(id);

    const show = (id) => el(id)?.classList.add("show");
    const hide = (id) => el(id)?.classList.remove("show");

    // âœ… SAFER setText + auto-hide topSub when empty
    const setText = (id, v) => {
      const n = el(id);
      if(!n) return;
      const val = (v ?? "").toString();
      n.textContent = val;
      if(id === "topSub"){
        n.style.display = val.trim() ? "block" : "none";
      }
    };

    const clampName = (s, fallback) => (String(s||"").trim() || fallback).slice(0, 24);

    function cleanRoomId(s){
      return (String(s||"").toUpperCase().trim().replace(/[^A-Z0-9]/g, "")).slice(0, 10);
    }
    function genRoomId(){
      const chars = "ABCDEFGHJKMNPQRSTUVWXYZ23456789";
      let out = "";
      for(let i=0;i<6;i++) out += chars[Math.floor(Math.random()*chars.length)];
      return out;
    }
    function deepClone(x){ return JSON.parse(JSON.stringify(x)); }

    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]] = [arr[j],arr[i]];
      }
    }

    function buildOrder(len, doShuffle=true){
      const order = Array.from({length:len}, (_,i)=>i);
      if(doShuffle) shuffle(order);
      return order;
    }

    function pickSampleIndices(total, want=10){
      const n = Math.min(total, want);
      const idx = Array.from({length: total}, (_,i)=>i);
      shuffle(idx);
      return idx.slice(0, n);
    }

    function nowISO(){ return new Date().toISOString(); }
    function fmtTime(ts){
      try{
        const d = new Date(ts);
        const hh = String(d.getHours()).padStart(2,"0");
        const mm = String(d.getMinutes()).padStart(2,"0");
        return `${hh}:${mm}`;
      }catch{ return ""; }
    }
    function normGender(g){
      const v = String(g||"").toLowerCase().trim();
      return (v === "female") ? "female" : "male";
    }
    function avatarForGender(g){
      const gg = normGender(g);
      return ICONS[gg] || ICONS.male;
    }

    function showChatErr(msg){
      const ce = el("chatErr");
      if(!ce) return;
      ce.style.display = msg ? "block" : "none";
      ce.textContent = msg || "";
    }

    function safeExtFromFile(file){
      const name = (file?.name || "").toLowerCase();
      const m = name.match(/\.(png|jpg|jpeg|webp|gif)$/);
      if(m) return m[1] === "jpeg" ? "jpg" : m[1];
      const ct = (file?.type || "").toLowerCase();
      if(ct.includes("png")) return "png";
      if(ct.includes("webp")) return "webp";
      if(ct.includes("gif")) return "gif";
      return "jpg";
    }

    async function uploadChatImage(file, roomId, uid){
      if(!file) throw new Error("No file selected");
      if(file.size > MAX_IMAGE_BYTES) throw new Error("Image too large. Max 4MB allowed.");
      if(!String(file.type || "").startsWith("image/")) throw new Error("Please select an image file.");

      const ext = safeExtFromFile(file);
      const path = `${cleanRoomId(roomId)}/${Date.now()}_${uid}.${ext}`;

      const { error: upErr } = await supabase
        .storage
        .from(CHAT_IMG_BUCKET)
        .upload(path, file, { upsert:false, contentType:file.type || "image/*" });

      if(upErr) throw upErr;

      const { data } = supabase.storage.from(CHAT_IMG_BUCKET).getPublicUrl(path);
      const url = data?.publicUrl;
      if(!url) throw new Error("Could not get image URL. Make bucket public.");
      return url;
    }

    // ---------------------------
    // Questions (Manage) - local
    // ---------------------------
    const QKEY = "party_questions_local_v3";
    const ADMIN_PASSWORD = "Admin@123";

    const SKEY = "party_settings_local_v1";
    const settings = { shuffleNhie:true, shufflePick:true };

    function loadSettings(){
      try{
        const v = JSON.parse(localStorage.getItem(SKEY));
        if(v && typeof v === "object"){
          settings.shuffleNhie = v.shuffleNhie !== false;
          settings.shufflePick = v.shufflePick !== false;
        }
      }catch{}
    }
    function saveSettings(){
      localStorage.setItem(SKEY, JSON.stringify(settings));
    }

    const SAMPLE_Q = {
      nhie:[
        "Never have I ever lied to my parents",
        "Never have I ever ghosted someone",
        "Never have I ever skipped a class",
        "Never have I ever stalked someoneâ€™s profile"
      ],
      pick:[
        {q:"Pick one", o1:"Pizza", o2:"Burger"},
        {q:"Pick one", o1:"Netflix", o2:"YouTube"},
        {q:"Pick one", o1:"Beach", o2:"Mountains"}
      ],
      truth:[
        "Whatâ€™s the most embarrassing thing youâ€™ve done?",
        "Who was your first crush?",
        "Whatâ€™s your biggest insecurity?",
        "Whatâ€™s a secret youâ€™ve never told anyone?"
      ],
      dare:[
        "Do 10 squats right now",
        "Send a funny voice note to your friend (optional)",
        "Do your best dance for 10 seconds",
        "Say â€˜I love pizzaâ€™ in a dramatic voice"
      ]
    };

    const questions = { nhie:[], pick:[], truth:[], dare:[] };

    function loadQuestions(){
      try{
        const v = JSON.parse(localStorage.getItem(QKEY));
        if(!v) throw 0;
        questions.nhie = Array.isArray(v.nhie) ? v.nhie : [];
        questions.pick = Array.isArray(v.pick) ? v.pick : [];
        questions.truth = Array.isArray(v.truth) ? v.truth : [];
        questions.dare = Array.isArray(v.dare) ? v.dare : [];
        return;
      }catch{}

      try{
        const old = JSON.parse(localStorage.getItem("party_questions_local_v2"));
        if(old && typeof old === "object"){
          questions.nhie = Array.isArray(old.nhie) ? old.nhie : deepClone(SAMPLE_Q.nhie);
          questions.pick = Array.isArray(old.pick) ? old.pick : deepClone(SAMPLE_Q.pick);
          questions.truth = deepClone(SAMPLE_Q.truth);
          questions.dare = deepClone(SAMPLE_Q.dare);
          saveQuestions();
          return;
        }
      }catch{}

      questions.nhie = deepClone(SAMPLE_Q.nhie);
      questions.pick = deepClone(SAMPLE_Q.pick);
      questions.truth = deepClone(SAMPLE_Q.truth);
      questions.dare = deepClone(SAMPLE_Q.dare);
      saveQuestions();
    }

    function saveQuestions(){
      localStorage.setItem(QKEY, JSON.stringify(questions));
    }

    // ---------------------------
    // Room doc model
    // ---------------------------
    function tdInit(){
      return {
        turn: "p1",
        phase: "spin",
        type: null,
        spinDeg: 0,
        spinToken: null,
        sample: [],
        chosenText: "",
        chosenIndex: null,
        chosenAt: null,
        chosenBy: null
      };
    }

    function makeNewRoomDoc({roomId, hostUid, hostName, hostGender, q, shuffleCfg}){
      const sh = shuffleCfg || { nhie:true, pick:true };
      return {
        roomId,
        status: "waiting",
        hostUid,
        players: {
          p1: { uid: hostUid, name: hostName, gender: normGender(hostGender) },
          p2: { uid: "", name: "", gender: "male" }
        },
        mode: "nhie",
        shuffle: sh,
        idx: 0,
        order: buildOrder((q?.nhie||[]).length, sh.nhie),
        questions: q || {nhie:[], pick:[], truth:[], dare:[]},
        td: tdInit(),
        chat: [],
        state: {
          counts: {p1:0,p2:0},
          last: {p1:"â€”",p2:"â€”"},
          nhieTurn: "p1",
          nhieAnswered: {p1:false,p2:false},
          pickLast: {p1:"â€”",p2:"â€”"},
          pickTurn: "p1",
          pickAnswered: {p1:false,p2:false},
        },
        updatedAt: Date.now()
      };
    }

    // ---------------------------
    // Supabase Room API
    // ---------------------------
    const RoomAPI = (() => {
      async function readRoom(roomId){
        const rid = cleanRoomId(roomId);
        const { data, error } = await supabase
          .from("rooms")
          .select("id, doc, version, updated_at")
          .eq("id", rid)
          .maybeSingle();
        if(error) throw error;
        return data || null;
      }

      async function createRoom({hostUid, hostName, hostGender, q, shuffleCfg}){
        for(let t=0;t<8;t++){
          const roomId = genRoomId();
          const doc = makeNewRoomDoc({roomId, hostUid, hostName, hostGender, q, shuffleCfg});
          const { error } = await supabase
            .from("rooms")
            .insert({ id: roomId, doc, version: 0 });
          if(!error) return { roomId, role:"p1" };
        }
        throw new Error("Could not create room. Try again.");
      }

      async function writeRoomCAS(roomId, expectedVersion, nextDoc){
        const { data, error } = await supabase
          .from("rooms")
          .update({ doc: nextDoc, version: expectedVersion + 1, updated_at: new Date().toISOString() })
          .eq("id", roomId)
          .eq("version", expectedVersion)
          .select("id")
          .maybeSingle();
        if(error) throw error;
        return !!data;
      }

      async function joinRoom({roomId, uid, name, gender}){
        const rid = cleanRoomId(roomId);
        const g = normGender(gender);

        for(let attempt=0; attempt<8; attempt++){
          const row = await readRoom(rid);
          if(!row) throw new Error("Room not found");

          const doc = row.doc;

          if(doc.players?.p1?.uid === uid){
            doc.players.p1.name = name || doc.players.p1.name;
            doc.players.p1.gender = g;
            doc.updatedAt = Date.now();
            const ok = await writeRoomCAS(rid, row.version, doc);
            if(ok) return { role:"p1", roomId: rid };
            continue;
          }
          if(doc.players?.p2?.uid === uid){
            doc.players.p2.name = name || doc.players.p2.name;
            doc.players.p2.gender = g;
            doc.updatedAt = Date.now();
            const ok = await writeRoomCAS(rid, row.version, doc);
            if(ok) return { role:"p2", roomId: rid };
            continue;
          }

          if(doc.players?.p2?.uid) throw new Error("Room is full");

          doc.players.p2.uid = uid;
          doc.players.p2.name = name;
          doc.players.p2.gender = g;
          doc.updatedAt = Date.now();

          const ok = await writeRoomCAS(rid, row.version, doc);
          if(ok) return { role:"p2", roomId: rid };
        }
        throw new Error("Join failed. Try again.");
      }

      async function patchRoom(roomId, patchFn){
        const rid = cleanRoomId(roomId);
        for(let attempt=0; attempt<10; attempt++){
          const row = await readRoom(rid);
          if(!row) throw new Error("Room not found");

          const doc = deepClone(row.doc);
          const next = patchFn(doc);
          next.updatedAt = Date.now();

          const ok = await writeRoomCAS(rid, row.version, next);
          if(ok) return;
        }
        throw new Error("Update failed (conflict). Try again.");
      }

      async function leaveRoom(roomId, uid){
        const rid = cleanRoomId(roomId);
        for(let attempt=0; attempt<8; attempt++){
          const row = await readRoom(rid);
          if(!row) return;

          const doc = deepClone(row.doc);
          const p1 = doc.players?.p1?.uid;
          const p2 = doc.players?.p2?.uid;

          if(p1 === uid){
            const { error } = await supabase.from("rooms").delete().eq("id", rid);
            if(error) throw error;
            return;
          }

          if(p2 === uid){
            doc.players.p2 = {uid:"", name:"", gender:"male"};
            doc.status = "waiting";
            doc.idx = 0;

            doc.state.last = {p1:"â€”",p2:"â€”"};
            doc.state.nhieAnswered = {p1:false,p2:false};
            doc.state.nhieTurn = "p1";

            doc.state.pickLast = {p1:"â€”",p2:"â€”"};
            doc.state.pickAnswered = {p1:false,p2:false};
            doc.state.pickTurn = "p1";

            doc.td = tdInit();
            doc.chat = [];

            doc.updatedAt = Date.now();
            const ok = await writeRoomCAS(rid, row.version, doc);
            if(ok) return;
          }else{
            return;
          }
        }
      }

      function subscribeRoom(roomId, cb){
        const rid = cleanRoomId(roomId);
        let cancelled = false;

        async function fetchOnce(){
          try{
            const row = await readRoom(rid);
            if(!cancelled) cb(row ? row.doc : null);
          }catch(e){
            console.error(e);
          }
        }

        fetchOnce();
        const poll = setInterval(fetchOnce, 1500);

        const channel = supabase
          .channel("room-" + rid)
          .on(
            "postgres_changes",
            { event: "*", schema: "public", table: "rooms", filter: `id=eq.${rid}` },
            fetchOnce
          )
          .subscribe();

        return () => {
          cancelled = true;
          clearInterval(poll);
          supabase.removeChannel(channel);
        };
      }

      return { createRoom, joinRoom, subscribeRoom, patchRoom, leaveRoom };
    })();

    // ---------------------------
    // Client state
    // ---------------------------
    const client = { uid:"", roomId:"", role:"", room:null, unsub:null };

    const ui = {
      tab: "chat",
      lastChatIdSeen: null,
      enteredPlayingOnce: false
    };

    function setScreen(name){
      ["screenHome","screenLobby","screenGame"].forEach(id => hide(id));
      show(name);
      const isGame = name === "screenGame";
      if(el("reset")) el("reset").disabled = !isGame;
      if(el("next"))  el("next").disabled  = !isGame;
      if(el("modeSeg")) el("modeSeg").style.display = isGame ? "flex" : "none";
    }

    function showHomeError(msg){
      const he = el("homeErr");
      if(!he) return;
      he.style.display = msg ? "block" : "none";
      he.textContent = msg || "";
    }
    function showLobbyError(msg){
      const le = el("lobbyErr");
      if(!le) return;
      le.style.display = msg ? "block" : "none";
      le.textContent = msg || "";
    }

    function buildShareLink(roomId){
      const u = new URL(window.location.href);
      u.searchParams.set("room", cleanRoomId(roomId));
      return u.toString();
    }

    function cleanupRoom(){
      if(client.unsub) client.unsub();
      client.unsub = null;
      client.room = null;
      client.roomId = "";
      client.role = "";
      ui.enteredPlayingOnce = false;
    }

    function subscribeRoom(roomId){
      if(client.unsub) client.unsub();
      client.unsub = RoomAPI.subscribeRoom(roomId, (doc) => {
        client.room = doc;
        if(!doc){
          cleanupRoom();
          setScreen("screenHome");
          showHomeError("Room ended or deleted.");
          return;
        }
        renderFromRoom(doc);
      });
    }

    function otherRole(r){ return r === "p1" ? "p2" : "p1"; }

    function getQ(room){
      const q = room.questions || {};
      return {
        nhie: Array.isArray(q.nhie) ? q.nhie : [],
        pick: Array.isArray(q.pick) ? q.pick : [],
        truth: Array.isArray(q.truth) ? q.truth : [],
        dare: Array.isArray(q.dare) ? q.dare : []
      };
    }

    function setProgress(room){
      const q = getQ(room);
      let pct = 0;
      if(room.mode === "nhie"){
        const total = q.nhie.length;
        pct = total ? Math.round(((room.idx+1)/total)*100) : 0;
      }else if(room.mode === "pick"){
        const total = q.pick.length;
        pct = total ? Math.round(((room.idx+1)/total)*100) : 0;
      }else{
        pct = 0;
      }
      if(el("progFill")) el("progFill").style.width = pct + "%";
    }

    function setActiveTab(tab){
      ui.tab = tab;

      if(tab === "chat"){
        el("tabChat")?.classList.remove("hasBell");
        ui.lastChatIdSeen = client.room?.chat?.length ? client.room.chat[client.room.chat.length-1]?.id : ui.lastChatIdSeen;
      }
      renderFromRoom(client.room || {});
    }

    function setModeUI(room){
      el("tabChat")?.classList.toggle("active", ui.tab === "chat");
      el("tabNhie")?.classList.toggle("active", ui.tab === "nhie");
      el("tabPick")?.classList.toggle("active", ui.tab === "pick");
      el("tabTD")?.classList.toggle("active", ui.tab === "td");

      const isChat = ui.tab === "chat";

      // âœ… Chat section
      if(el("chatArea")) el("chatArea").style.display = isChat ? "block" : "none";

      // âœ… Hide "game section" completely while in Chat
      if(el("gameOnly")) el("gameOnly").style.display = isChat ? "none" : "block";

      // âœ… Game areas (only when not in chat)
      if(el("nhieArea")) el("nhieArea").style.display = (!isChat && room.mode === "nhie") ? "block" : "none";
      if(el("pickArea")) el("pickArea").style.display = (!isChat && room.mode === "pick") ? "block" : "none";
      if(el("tdArea"))   el("tdArea").style.display   = (!isChat && room.mode === "td")   ? "block" : "none";

      if(el("bottomBar")) el("bottomBar").style.display = (isChat || room.mode === "td") ? "none" : "flex";
    }

    function getCurrentItem(room){
      const q = getQ(room);
      const list = room.mode === "nhie" ? q.nhie : q.pick;
      if(!list.length) return null;
      const realIdx = room.order?.[room.idx] ?? 0;
      return list[realIdx] ?? null;
    }

    function updateAvatars(room){
      const p1g = room.players?.p1?.gender || "male";
      const p2g = room.players?.p2?.gender || "male";
      if(el("lobbyP1Av")) el("lobbyP1Av").src = avatarForGender(p1g);
      if(el("lobbyP2Av")) el("lobbyP2Av").src = avatarForGender(p2g);
      if(el("p1Av")) el("p1Av").src = avatarForGender(p1g);
      if(el("p2Av")) el("p2Av").src = avatarForGender(p2g);
    }

    function updateNhieUI(room){
      const a1 = room.state.last.p1 || "â€”";
      const a2 = room.state.last.p2 || "â€”";
      setText("p1SelMini", (room.players.p1.name || "Player 1") + " â€¢ Selection");
      setText("p2SelMini", (room.players.p2.name || "Player 2") + " â€¢ Selection");
      setText("p1SelBox", a1); setText("p2SelBox", a2);
      el("p1SelBox")?.classList.toggle("selected", a1 !== "â€”");
      el("p2SelBox")?.classList.toggle("selected", a2 !== "â€”");

      const d1 = !!room.state.nhieAnswered.p1;
      const d2 = !!room.state.nhieAnswered.p2;
      setText("p1Badge", d1 ? "Done" : "Pending");
      setText("p2Badge", d2 ? "Done" : "Pending");
      el("p1Badge")?.classList.toggle("done", d1);
      el("p2Badge")?.classList.toggle("done", d2);

      const turn = room.state.nhieTurn;
      setText("nhieTurnPill", "Turn: " + (turn==="p1" ? (room.players.p1.name||"P1") : (room.players.p2.name||"P2")));

      const both = d1 && d2;
      if(both){
        setText("nhieStatus", "Both answered âœ… Host can tap Next.");
        if(el("nhieHave")) el("nhieHave").disabled = true;
        if(el("nhieNever")) el("nhieNever").disabled = true;
      }else{
        const tName = turn==="p1" ? (room.players.p1.name||"P1") : (room.players.p2.name||"P2");
        setText("nhieStatus", tName + " select: I Have / I Never");
        const myTurn = client.role === turn;
        if(el("nhieHave")) el("nhieHave").disabled = !myTurn;
        if(el("nhieNever")) el("nhieNever").disabled = !myTurn;
      }

      const sel = room.state.last[turn];
      el("nhieHave")?.classList.toggle("selected", sel === "I Have");
      el("nhieNever")?.classList.toggle("selected", sel === "I Never");
    }

    function updatePickUI(room){
      const t = room.state.pickTurn;
      setText("pickTurnPill", "Turn: " + (t==="p1" ? (room.players.p1.name||"P1") : (room.players.p2.name||"P2")));

      const v1 = room.state.pickLast.p1 || "â€”";
      const v2 = room.state.pickLast.p2 || "â€”";
      setText("p1PickBox", v1);
      setText("p2PickBox", v2);
      el("p1PickBox")?.classList.toggle("selected", v1 !== "â€”");
      el("p2PickBox")?.classList.toggle("selected", v2 !== "â€”");

      const a1 = !!room.state.pickAnswered.p1;
      const a2 = !!room.state.pickAnswered.p2;
      const both = a1 && a2;

      if(both){
        setText("pickStatus", "Both answered âœ… Host can tap Next.");
        if(el("opt1Btn")) el("opt1Btn").disabled = true;
        if(el("opt2Btn")) el("opt2Btn").disabled = true;
      }else{
        const tName = t==="p1" ? (room.players.p1.name||"P1") : (room.players.p2.name||"P2");
        setText("pickStatus", tName + " select an option.");
        const myTurn = client.role === t;
        if(el("opt1Btn")) el("opt1Btn").disabled = !myTurn;
        if(el("opt2Btn")) el("opt2Btn").disabled = !myTurn;
      }

      const sel = room.state.pickLast[t];
      const o1 = el("opt1Btn")?.textContent || "Option 1";
      const o2 = el("opt2Btn")?.textContent || "Option 2";
      el("opt1Btn")?.classList.toggle("selected", sel && sel !== "â€”" && sel === o1);
      el("opt2Btn")?.classList.toggle("selected", sel && sel !== "â€”" && sel === o2);
    }

    function escapeHtml(s){
      return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function renderChat(room){
      const msgs = Array.isArray(room.chat) ? room.chat : [];
      const wrap = el("chatMsgs");
      if(!wrap) return;

      // âœ… Chat header: ONLY show the OTHER person's name + icon (not both)
      const my = client.role || "p1";
      const other = otherRole(my);

      const otherP = other==="p1" ? room.players?.p1 : room.players?.p2;
      const otherName = (otherP?.name || (other==="p1" ? "P1" : "P2")).toString().slice(0,24);
      const otherGender = normGender(otherP?.gender || "male");
      const otherAv = avatarForGender(otherGender);

      const titleEl = el("chatTitleNames");
      if(titleEl){
        titleEl.innerHTML = `
          <img class="av" src="${escapeHtml(otherAv)}" alt="avatar">
          <span>${escapeHtml(otherName)}</span>
        `;
      }

      const lastId = msgs.length ? msgs[msgs.length-1]?.id : null;
      const newIncoming = lastId && lastId !== ui.lastChatIdSeen;

      if(ui.tab !== "chat" && newIncoming){
        el("tabChat")?.classList.add("hasBell");
        if(document && document.title && !document.title.startsWith("â€¢ ")){
          document.title = "â€¢ " + document.title;
        }
      }
      if(ui.tab === "chat"){
        el("tabChat")?.classList.remove("hasBell");
        if(document && document.title){
          document.title = document.title.replace(/^â€¢\s*/,"");
        }
        if(lastId) ui.lastChatIdSeen = lastId;
      }

      if(!msgs.length){
        wrap.innerHTML = `<div class="tiny">No messages yet. Start the conversation ðŸ™‚</div>`;
        return;
      }

      wrap.innerHTML = msgs.map(m => {
        const role = m?.role || "";
        const isMe = role === client.role;
        const t = m?.ts || null;
        const time = t ? fmtTime(t) : "";
        const gender = normGender(m?.gender || (role==="p1" ? room.players?.p1?.gender : room.players?.p2?.gender));
        const av = avatarForGender(gender);

        const type = m?.type || "text";
        const text = escapeHtml((m?.text || "").toString().slice(0,220));
        const imgUrl = (m?.url || "").toString();

        const body = type === "image"
          ? `
              ${text ? `<div>${text}</div>` : ``}
              <div class="imgWrap">
                <a href="${escapeHtml(imgUrl)}" target="_blank" rel="noreferrer">
                  <img src="${escapeHtml(imgUrl)}" alt="image"/>
                </a>
              </div>
            `
          : `<div>${text}</div>`;

        return `
          <div class="bubbleRow ${isMe ? "me" : ""}">
            ${isMe ? "" : `<img class="av" src="${av}" alt="avatar">`}
            <div class="bubble ${isMe ? "me" : ""}">
              ${body}
              ${time ? `<div class="bTime">${escapeHtml(time)}</div>` : ``}
            </div>
            ${isMe ? `<img class="av" src="${av}" alt="avatar">` : ""}
          </div>
        `;
      }).join("");

      wrap.scrollTop = wrap.scrollHeight;
    }

    let lastSpinTokenLocal = null;

    function setBadge(type){
      const b = el("tdResultBadge");
      if(!b) return;
      b.classList.remove("truth","dare");
      if(type === "truth"){
        b.classList.add("truth");
        b.textContent = "TRUTH";
      }else if(type === "dare"){
        b.classList.add("dare");
        b.textContent = "DARE";
      }else{
        b.textContent = "â€”";
      }
    }

    function showChosenBox(room){
      const box = el("tdChosenBox");
      if(!box) return;
      const txt = room.td?.chosenText || "";
      if(txt){
        box.style.display = "block";
        setText("tdChosenText", txt);
        const who = room.td?.chosenBy || "â€”";
        const t = room.td?.type || "â€”";
        setText("tdChosenMeta", `Type: ${String(t).toUpperCase()} â€¢ Picked by: ${who.toUpperCase()}`);
      }else{
        box.style.display = "none";
        setText("tdChosenText", "â€”");
        setText("tdChosenMeta", "â€”");
      }
    }

    const WHEEL_SLICE_COUNT = 8;
    const WHEEL_DARE_INDEX = 2;
    function renderWheelLabels(){
      const wrap = el("wheelText");
      if(!wrap) return;
      const seg = 360 / WHEEL_SLICE_COUNT;
      wrap.innerHTML = Array.from({length: WHEEL_SLICE_COUNT}, (_,i)=>{
        const isDare = i === WHEEL_DARE_INDEX;
        const label = isDare ? "DARE" : "TRUTH";
        const angle = (-90 + i*seg + seg/2);
        const cls = "lbl" + (isDare ? " dare" : "");
        return `
          <div class="${cls}" style="transform: translate(-50%,-50%) rotate(${angle}deg) translate(78px) rotate(${90}deg);">
            <span>${label}</span>
          </div>
        `;
      }).join("");
    }

    function updateTDUI(room){
      room.td = room.td || tdInit();

      const turn = room.td.turn || "p1";
      const turnName = turn==="p1" ? (room.players.p1.name||"P1") : (room.players.p2.name||"P2");
      setText("tdTurnPill", `Turn: ${turnName}`);
      setText("tdPhasePill", `Phase: ${room.td.phase || "spin"}`);

      const phase = room.td.phase || "spin";
      const type = room.td.type;
      setBadge(type);

      const other = otherRole(turn);

      const canSpin = (phase === "spin") && (client.role === turn);
      const canShuffle = (phase === "list") && (client.role === other);
      const canNext = (phase === "chosen") && (client.role === turn);

      if(el("tdSpinBtn")) el("tdSpinBtn").disabled = !canSpin;
      if(el("wheelSpinBtn")) el("wheelSpinBtn").disabled = !canSpin;
      if(el("tdShuffleBtn")) el("tdShuffleBtn").disabled = !canShuffle;
      if(el("tdNextBtn")) el("tdNextBtn").disabled = !canNext;

      const wheel = el("wheel");
      const token = room.td.spinToken || null;
      const deg = Number(room.td.spinDeg || 0);

      if(wheel){
        if(token && token !== lastSpinTokenLocal){
          lastSpinTokenLocal = token;
          wheel.style.transform = `rotate(${deg}deg)`;
        }else if(!token){
          wheel.style.transform = `rotate(0deg)`;
        }
      }

      if(phase === "spin"){
        setText("qText", "Truth / Dare");
        setText("qMeta", `${turnName} spins â€¢ other player selects`);
        setText("tdHint", `${turnName} spin karega. Dusra player cards me se select karega.`);
        setBadge(null);
      }else if(phase === "list"){
        setText("qText", "Truth / Dare");
        setText("qMeta", `Cards ready â€¢ pick 1`);
        setText("tdHint", `Select 1 card. (Shuffle available)`);
      }else{
        setText("qText", "Truth / Dare");
        setText("qMeta", `Selected âœ…`);
        setText("tdHint", `Done? Turn player "Next Spin" dabaye.`);
      }

      const cardsWrap = el("tdCards");
      const sample = Array.isArray(room.td.sample) ? room.td.sample : [];
      const chosenIndex = (room.td.chosenIndex ?? null);

      if(cardsWrap){
        if(phase === "spin"){
          cardsWrap.innerHTML = `<div class="tiny">Spin ke baad yahan 10 cards dikhenge.</div>`;
        }else{
          if(!sample.length){
            cardsWrap.innerHTML = `<div class="tiny">No cards found. Add more in Manage â†’ Truth/Dare.</div>`;
          }else{
            const otherCanClick = (phase === "list") && (client.role === other);
            cardsWrap.innerHTML = sample.map((t,i)=> {
              const safe = escapeHtml(String(t||""));
              const isSel = (chosenIndex !== null && Number(chosenIndex) === i);
              const cls = "cardBtn" + (isSel ? " selected" : "");
              const dis = otherCanClick ? "" : "disabled";
              return `<button class="${cls}" data-tdpick="${i}" ${dis}>${safe}</button>`;
            }).join("");
          }
        }
      }

      showChosenBox(room);
      setProgress(room);
    }

    function renderFromRoom(room){
      if(!room) return;

      setText("lobbyRoomId", room.roomId);
      setText("lobbyP1", room.players.p1.name || "Waitingâ€¦");
      setText("lobbyP2", room.players.p2.name || "Waitingâ€¦");
      setText("lobbyRolePill", "Role: " + (client.role || "â€”"));
      if(el("shareLink")) el("shareLink").value = buildShareLink(room.roomId);

      updateAvatars(room);

      const bothJoined = !!(room.players.p1.uid && room.players.p2.uid);
      if(el("startGame")) el("startGame").disabled = !(bothJoined && client.role === "p1");

      if(room.status === "waiting"){
        setScreen("screenLobby");
        setText("lobbyHint", bothJoined
          ? "Both players joined âœ… Host can start the game."
          : "Waiting for Player 2 to joinâ€¦");
      }
      if(room.status === "playing"){
        setScreen("screenGame");
      }

      setText("gameRoomId", room.roomId);
      setText("gameMeRole", client.role || "â€”");

      if(room.status === "playing" && !ui.enteredPlayingOnce){
        ui.enteredPlayingOnce = true;
        ui.tab = "chat";
      }

      renderChat(room);

      if(room.status !== "playing"){
        return;
      }

      setText("p1Name", room.players.p1.name || "Player 1");
      setText("p2Name", room.players.p2.name || "Player 2");
      setText("p1Name2", room.players.p1.name || "Player 1");
      setText("p2Name2", room.players.p2.name || "Player 2");

      room.td = room.td || tdInit();
      room.chat = Array.isArray(room.chat) ? room.chat : [];

      setModeUI(room);

      const q = getQ(room);
      const item = getCurrentItem(room);

      if(room.mode === "nhie" || room.mode === "pick"){
        setText("p1Count", room.state.counts.p1 || 0);
        setText("p2Count", room.state.counts.p2 || 0);

        const nhieDone = room.state.nhieAnswered.p1 && room.state.nhieAnswered.p2;
        el("scoreP1")?.classList.toggle("active", room.mode==="nhie" && room.state.nhieTurn==="p1" && !nhieDone);
        el("scoreP2")?.classList.toggle("active", room.mode==="nhie" && room.state.nhieTurn==="p2" && !nhieDone);
        if(room.mode!=="nhie"){ el("scoreP1")?.classList.remove("active"); el("scoreP2")?.classList.remove("active"); }

        if(!item){
          setText("qText", "No questions yet.");
          setText("qMeta", "Open Manage â†’ add questions");
          if(el("opt1Btn")) el("opt1Btn").textContent = "Option 1";
          if(el("opt2Btn")) el("opt2Btn").textContent = "Option 2";
          setProgress(room);
          updateNhieUI(room);
          updatePickUI(room);
        }else if(room.mode === "nhie"){
          setText("qText", item);
          setText("qMeta", `Never Have I Ever â€¢ ${room.idx+1}/${q.nhie.length}`);
          setProgress(room);
          updateNhieUI(room);
        }else{
          const qq = item.q?.trim() ? item.q.trim() : "Pick one";
          setText("qText", qq);
          setText("qMeta", `Pick One â€¢ ${room.idx+1}/${q.pick.length}`);
          if(el("opt1Btn")) el("opt1Btn").textContent = item.o1 || "Option 1";
          if(el("opt2Btn")) el("opt2Btn").textContent = item.o2 || "Option 2";
          setProgress(room);
          updatePickUI(room);
        }

        if(el("next")) el("next").disabled = !(client.role==="p1");
        if(el("reset")) el("reset").disabled = !(client.role==="p1");
      }

      if(room.mode === "td"){
        updateTDUI(room);
      }
    }

    // ---------------------------
    // Room flows
    // ---------------------------
    async function createRoomFlow(){
      showHomeError("");
      const myName = clampName(el("myNameCreate")?.value, "Player 1");
      const myGender = normGender(el("myGenderCreate")?.value);
      try{
        const q = deepClone(questions);
        const { roomId, role } = await RoomAPI.createRoom({
          hostUid: client.uid,
          hostName: myName,
          hostGender: myGender,
          q,
          shuffleCfg: { nhie: settings.shuffleNhie, pick: settings.shufflePick }
        });
        client.role = role;
        client.roomId = roomId;
        ui.tab = "chat";
        ui.enteredPlayingOnce = false;
        setText("topSub", "");
        subscribeRoom(roomId);
      }catch(err){
        console.error(err);
        showHomeError(err?.message || "Failed to create room");
      }
    }

    async function joinRoomFlow(roomIdFromUrl){
      showHomeError("");
      const roomId = cleanRoomId(roomIdFromUrl || el("roomIdJoin")?.value || "");
      const myName = clampName(el("myNameJoin")?.value, "Player 2");
      const myGender = normGender(el("myGenderJoin")?.value);
      if(!roomId) return showHomeError("Please enter Room code (example: AB12CD).");

      try{
        const { role, roomId: rid } = await RoomAPI.joinRoom({ roomId, uid: client.uid, name: myName, gender: myGender });
        client.role = role;
        client.roomId = rid;
        ui.tab = "chat";
        ui.enteredPlayingOnce = false;
        setText("topSub", "");
        subscribeRoom(rid);
      }catch(err){
        console.error(err);
        showHomeError(err?.message || "Failed to join room");
      }
    }

    async function startGameFlow(){
      showLobbyError("");
      if(client.role !== "p1") return;
      if(!client.roomId) return;

      try{
        const q = deepClone(questions);
        await RoomAPI.patchRoom(client.roomId, (doc) => {
          const both = doc.players.p1.uid && doc.players.p2.uid;
          if(!both) return doc;

          doc.shuffle = doc.shuffle || { nhie:true, pick:true };
          doc.questions = q;
          doc.status = "playing";
          doc.mode = doc.mode || "nhie";

          const len = doc.mode === "nhie" ? (q.nhie||[]).length : (q.pick||[]).length;
          const doShuffle = doc.mode === "nhie" ? doc.shuffle.nhie : doc.shuffle.pick;
          doc.order = buildOrder(len, doShuffle);
          doc.idx = 0;

          doc.state.last = {p1:"â€”",p2:"â€”"};
          doc.state.nhieAnswered = {p1:false,p2:false};
          doc.state.nhieTurn = "p1";

          doc.state.pickLast = {p1:"â€”",p2:"â€”"};
          doc.state.pickAnswered = {p1:false,p2:false};
          doc.state.pickTurn = "p1";

          doc.td = tdInit();
          doc.chat = [];

          return doc;
        });

        ui.tab = "chat";
        setText("topSub", "");
      }catch(err){
        console.error(err);
        showLobbyError(err?.message || "Cannot start");
      }
    }

    async function leaveRoomFlow(){
      try{
        if(client.roomId){
          await RoomAPI.leaveRoom(client.roomId, client.uid);
        }
      }catch(e){ console.error(e); }
      cleanupRoom();
      setScreen("screenHome");
    }

    async function setMode(mode){
      if(client.role !== "p1") return;
      if(!client.roomId) return;

      await RoomAPI.patchRoom(client.roomId, (doc) => {
        doc.mode = mode;
        doc.shuffle = doc.shuffle || { nhie:true, pick:true };

        const q = getQ(doc);

        if(mode === "nhie" || mode === "pick"){
          const len = mode === "nhie" ? q.nhie.length : q.pick.length;
          const doShuffle = mode === "nhie" ? doc.shuffle.nhie : doc.shuffle.pick;

          doc.order = buildOrder(len, doShuffle);
          doc.idx = 0;

          doc.state.last = {p1:"â€”",p2:"â€”"};
          doc.state.nhieAnswered = {p1:false,p2:false};
          doc.state.nhieTurn = "p1";

          doc.state.pickLast = {p1:"â€”",p2:"â€”"};
          doc.state.pickAnswered = {p1:false,p2:false};
          doc.state.pickTurn = "p1";
        }else{
          doc.td = doc.td || tdInit();
          doc.td.turn = "p1";
          doc.td.phase = "spin";
          doc.td.type = null;
          doc.td.spinDeg = 0;
          doc.td.spinToken = null;
          doc.td.sample = [];
          doc.td.chosenText = "";
          doc.td.chosenIndex = null;
          doc.td.chosenBy = null;
          doc.td.chosenAt = null;
        }
        return doc;
      });
    }

    async function nhieSelect(answerText){
      if(!client.roomId) return;
      await RoomAPI.patchRoom(client.roomId, (doc) => {
        if(doc.status !== "playing") return doc;
        if(doc.mode !== "nhie") return doc;

        const turn = doc.state.nhieTurn;
        if(client.role !== turn) return doc;
        if(doc.state.nhieAnswered[turn]) return doc;

        doc.state.last[turn] = answerText;
        doc.state.nhieAnswered[turn] = true;

        if(answerText === "I Have"){
          doc.state.counts[turn] = (doc.state.counts[turn] || 0) + 1;
        }

        const other = (turn === "p1") ? "p2" : "p1";
        if(!doc.state.nhieAnswered[other]){
          doc.state.nhieTurn = other;
        }
        return doc;
      });
    }

    async function pickSelect(optionText){
      if(!client.roomId) return;
      await RoomAPI.patchRoom(client.roomId, (doc) => {
        if(doc.status !== "playing") return doc;
        if(doc.mode !== "pick") return doc;

        const turn = doc.state.pickTurn;
        if(client.role !== turn) return doc;
        if(doc.state.pickAnswered[turn]) return doc;

        doc.state.pickLast[turn] = optionText;
        doc.state.pickAnswered[turn] = true;

        const other = (turn === "p1") ? "p2" : "p1";
        if(!doc.state.pickAnswered[other]){
          doc.state.pickTurn = other;
        }
        return doc;
      });
    }

    async function nextQuestion(){
      if(client.role !== "p1") return;
      if(!client.roomId) return;

      await RoomAPI.patchRoom(client.roomId, (doc) => {
        if(doc.status !== "playing") return doc;
        if(doc.mode !== "nhie" && doc.mode !== "pick") return doc;

        const q = getQ(doc);
        const len = doc.mode === "nhie" ? q.nhie.length : q.pick.length;
        if(!len) return doc;

        if(doc.mode === "nhie"){
          if(!(doc.state.nhieAnswered.p1 && doc.state.nhieAnswered.p2)) return doc;
        }else{
          if(!(doc.state.pickAnswered.p1 && doc.state.pickAnswered.p2)) return doc;
        }

        doc.idx = (doc.idx + 1) % len;

        doc.state.last = {p1:"â€”",p2:"â€”"};
        doc.state.nhieAnswered = {p1:false,p2:false};
        doc.state.nhieTurn = "p1";

        doc.state.pickLast = {p1:"â€”",p2:"â€”"};
        doc.state.pickAnswered = {p1:false,p2:false};
        doc.state.pickTurn = "p1";

        return doc;
      });
    }

    async function resetGame(){
      if(client.role !== "p1") return;
      if(!client.roomId) return;

      await RoomAPI.patchRoom(client.roomId, (doc) => {
        if(doc.mode === "td"){
          doc.td = tdInit();
          return doc;
        }

        const q = getQ(doc);
        const len = doc.mode === "nhie" ? q.nhie.length : q.pick.length;

        doc.shuffle = doc.shuffle || { nhie:true, pick:true };
        const doShuffle = doc.mode === "nhie" ? doc.shuffle.nhie : doc.shuffle.pick;

        doc.state.counts = {p1:0,p2:0};
        doc.idx = 0;
        doc.order = buildOrder(len, doShuffle);

        doc.state.last = {p1:"â€”",p2:"â€”"};
        doc.state.nhieAnswered = {p1:false,p2:false};
        doc.state.nhieTurn = "p1";

        doc.state.pickLast = {p1:"â€”",p2:"â€”"};
        doc.state.pickAnswered = {p1:false,p2:false};
        doc.state.pickTurn = "p1";

        return doc;
      });
    }

    function tdPool(doc){
      const q = getQ(doc);
      return { truth: q.truth, dare: q.dare };
    }

    function pickWheelTargetIndex(type){
      const idx = [];
      for(let i=0;i<8;i++){
        const isDare = i === 2;
        if(type === "dare" && isDare) idx.push(i);
        if(type === "truth" && !isDare) idx.push(i);
      }
      return idx[Math.floor(Math.random()*idx.length)];
    }

    function computeStopDegForIndex(index){
      const seg = 360 / 8;
      const jitterMax = (seg/2) - 4;
      const jitter = (Math.random() * (jitterMax*2)) - jitterMax;
      const centerAngle = (index * seg) + (seg/2) + jitter;
      const stop = (360 - centerAngle) % 360;
      return stop < 0 ? stop + 360 : stop;
    }

    async function tdSpin(){
      if(!client.roomId) return;
      await RoomAPI.patchRoom(client.roomId, (doc) => {
        if(doc.status !== "playing") return doc;
        if(doc.mode !== "td") return doc;

        doc.td = doc.td || tdInit();
        const turn = doc.td.turn || "p1";

        if(doc.td.phase !== "spin") return doc;
        if(client.role !== turn) return doc;

        const type = (Math.random() < 0.10) ? "dare" : "truth";
        const targetIndex = pickWheelTargetIndex(type);

        const spins = 6 + Math.floor(Math.random()*3);
        const stop = computeStopDegForIndex(targetIndex);
        const deg = spins*360 + stop;

        const pool = tdPool(doc)[type] || [];
        const pick = pickSampleIndices(pool.length, 10);
        const sample = pick.map(i => pool[i]);

        doc.td.spinDeg = deg;
        doc.td.spinToken = Date.now() + "_" + Math.random().toString(16).slice(2);
        doc.td.type = type;
        doc.td.sample = sample;
        doc.td.phase = "list";
        doc.td.chosenText = "";
        doc.td.chosenIndex = null;
        doc.td.chosenBy = null;
        doc.td.chosenAt = null;

        return doc;
      });
    }

    async function tdShuffleSample(){
      if(!client.roomId) return;
      await RoomAPI.patchRoom(client.roomId, (doc) => {
        if(doc.status !== "playing") return doc;
        if(doc.mode !== "td") return doc;

        doc.td = doc.td || tdInit();
        const turn = doc.td.turn || "p1";
        const other = otherRole(turn);

        if(doc.td.phase !== "list") return doc;
        if(client.role !== other) return doc;

        const type = doc.td.type;
        if(type !== "truth" && type !== "dare") return doc;

        const pool = tdPool(doc)[type] || [];
        const pick = pickSampleIndices(pool.length, 10);
        doc.td.sample = pick.map(i => pool[i]);
        return doc;
      });
    }

    async function tdChoose(sampleIndex){
      if(!client.roomId) return;
      await RoomAPI.patchRoom(client.roomId, (doc) => {
        if(doc.status !== "playing") return doc;
        if(doc.mode !== "td") return doc;

        doc.td = doc.td || tdInit();
        const turn = doc.td.turn || "p1";
        const other = otherRole(turn);

        if(doc.td.phase !== "list") return doc;
        if(client.role !== other) return doc;

        const sample = Array.isArray(doc.td.sample) ? doc.td.sample : [];
        const txt = sample[sampleIndex];
        if(!txt) return doc;

        doc.td.chosenText = txt;
        doc.td.chosenIndex = sampleIndex;
        doc.td.chosenBy = other;
        doc.td.chosenAt = nowISO();
        doc.td.phase = "chosen";

        return doc;
      });
    }

    async function tdNextSpin(){
      if(!client.roomId) return;
      await RoomAPI.patchRoom(client.roomId, (doc) => {
        if(doc.status !== "playing") return doc;
        if(doc.mode !== "td") return doc;

        doc.td = doc.td || tdInit();
        const turn = doc.td.turn || "p1";

        if(doc.td.phase !== "chosen") return doc;
        if(client.role !== turn) return doc;

        doc.td.turn = otherRole(turn);
        doc.td.phase = "spin";
        doc.td.type = null;
        doc.td.sample = [];
        doc.td.chosenText = "";
        doc.td.chosenIndex = null;
        doc.td.chosenBy = null;
        doc.td.chosenAt = null;
        return doc;
      });
    }

    async function chatSendText(){
      showChatErr("");
      if(!client.roomId) return;
      const input = el("chatInput");
      const text = (input?.value || "").trim();
      if(!text) return;

      if(input) input.value = "";

      await RoomAPI.patchRoom(client.roomId, (doc) => {
        if(doc.status !== "playing") return doc;
        doc.chat = Array.isArray(doc.chat) ? doc.chat : [];

        const myP = client.role === "p1" ? doc.players.p1 : doc.players.p2;
        const myName = myP?.name || (client.role==="p1" ? "P1" : "P2");
        const myGender = normGender(myP?.gender || "male");

        const msg = {
          id: `${Date.now()}_${Math.random().toString(16).slice(2)}`,
          uid: client.uid,
          role: client.role,
          name: myName,
          gender: myGender,
          type: "text",
          text: text.slice(0, 220),
          ts: nowISO()
        };

        doc.chat.push(msg);
        if(doc.chat.length > 40) doc.chat = doc.chat.slice(-40);
        return doc;
      });
    }

    async function chatSendImage(file){
      showChatErr("");
      if(!client.roomId) return;
      if(!file) return;

      try{
        const url = await uploadChatImage(file, client.roomId, client.uid);

        await RoomAPI.patchRoom(client.roomId, (doc) => {
          if(doc.status !== "playing") return doc;
          doc.chat = Array.isArray(doc.chat) ? doc.chat : [];

          const myP = client.role === "p1" ? doc.players.p1 : doc.players.p2;
          const myName = myP?.name || (client.role==="p1" ? "P1" : "P2");
          const myGender = normGender(myP?.gender || "male");

          const caption = (el("chatInput")?.value || "").trim();
          if(el("chatInput")) el("chatInput").value = "";

          const msg = {
            id: `${Date.now()}_${Math.random().toString(16).slice(2)}`,
            uid: client.uid,
            role: client.role,
            name: myName,
            gender: myGender,
            type: "image",
            url,
            text: caption.slice(0, 220),
            ts: nowISO()
          };

          doc.chat.push(msg);
          if(doc.chat.length > 40) doc.chat = doc.chat.slice(-40);
          return doc;
        });
      }catch(err){
        console.error(err);
        showChatErr(err?.message || "Image upload failed.");
      }finally{
        if(el("chatFile")) el("chatFile").value = "";
      }
    }

    function renderLists(){
      el("nhieList").innerHTML = questions.nhie.length
        ? questions.nhie.map((q,i)=>`
          <div class="listItem">
            <div>${escapeHtml(q)}</div>
            <button class="del" data-del-nhie="${i}">Delete</button>
          </div>
        `).join("")
        : `<div class="tiny">No NHIE questions.</div>`;

      el("pickList").innerHTML = questions.pick.length
        ? questions.pick.map((p,i)=>`
          <div class="listItem">
            <div><b>${escapeHtml(p.o1||"Option 1")}</b> vs <b>${escapeHtml(p.o2||"Option 2")}</b></div>
            <button class="del" data-del-pick="${i}">Delete</button>
          </div>
        `).join("")
        : `<div class="tiny">No Pick One questions.</div>`;

      el("truthList").innerHTML = questions.truth.length
        ? questions.truth.map((t,i)=>`
          <div class="listItem">
            <div>${escapeHtml(t)}</div>
            <button class="del" data-del-truth="${i}">Delete</button>
          </div>
        `).join("")
        : `<div class="tiny">No Truth questions.</div>`;

      el("dareList").innerHTML = questions.dare.length
        ? questions.dare.map((t,i)=>`
          <div class="listItem">
            <div>${escapeHtml(t)}</div>
            <button class="del" data-del-dare="${i}">Delete</button>
          </div>
        `).join("")
        : `<div class="tiny">No Dare questions.</div>`;
    }

    function openSheet(){
      el("overlay")?.classList.add("show");
      const unlocked = localStorage.getItem("admin_unlocked_supabase")==="1";
      if(el("adminLogin")) el("adminLogin").style.display = unlocked ? "none" : "block";
      if(el("adminPanel")) el("adminPanel").style.display = unlocked ? "block" : "none";
      if(unlocked){
        renderLists();
        if(el("shuffleNhie")) el("shuffleNhie").checked = settings.shuffleNhie;
        if(el("shufflePick")) el("shufflePick").checked = settings.shufflePick;
      }
      if(el("adminPass")){
        el("adminPass").value = "";
        el("adminPass").setAttribute("readonly","readonly");
        setTimeout(()=>el("adminPass").blur(), 0);
      }
    }
    function closeSheet(){ el("overlay")?.classList.remove("show"); }

    // Wire events
    el("btnCreateRoom")?.addEventListener("click", createRoomFlow);
    el("btnJoinRoom")?.addEventListener("click", () => joinRoomFlow(""));

    el("startGame")?.addEventListener("click", startGameFlow);
    el("leaveRoom")?.addEventListener("click", leaveRoomFlow);

    el("copyLink")?.addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(el("shareLink").value);
        el("copyLink").textContent = "Copied âœ…";
        setTimeout(()=> el("copyLink").textContent = "Copy Link", 900);
      }catch{
        el("shareLink").select();
        document.execCommand("copy");
      }
    });

    el("tabChat")?.addEventListener("click", ()=> setActiveTab("chat"));
    el("tabNhie")?.addEventListener("click", ()=> { setActiveTab("nhie"); setMode("nhie"); });
    el("tabPick")?.addEventListener("click", ()=> { setActiveTab("pick"); setMode("pick"); });
    el("tabTD")?.addEventListener("click", ()=> { setActiveTab("td"); setMode("td"); });

    el("nhieHave")?.addEventListener("click", ()=> nhieSelect("I Have"));
    el("nhieNever")?.addEventListener("click", ()=> nhieSelect("I Never"));

    el("opt1Btn")?.addEventListener("click", ()=> pickSelect(el("opt1Btn").textContent || "Option 1"));
    el("opt2Btn")?.addEventListener("click", ()=> pickSelect(el("opt2Btn").textContent || "Option 2"));

    el("next")?.addEventListener("click", nextQuestion);
    el("reset")?.addEventListener("click", resetGame);

    el("openAdmin")?.addEventListener("click", openSheet);
    el("closeSheet")?.addEventListener("click", closeSheet);

    el("adminPass")?.addEventListener("pointerdown", ()=> el("adminPass").removeAttribute("readonly"));
    el("adminPass")?.addEventListener("focus", ()=> el("adminPass").removeAttribute("readonly"));

    el("unlock")?.addEventListener("click", ()=>{
      const pass = (el("adminPass").value || "").trim();
      if(pass === ADMIN_PASSWORD){
        localStorage.setItem("admin_unlocked_supabase","1");
        el("adminLogin").style.display = "none";
        el("adminPanel").style.display = "block";
        renderLists();
        if(el("shuffleNhie")) el("shuffleNhie").checked = settings.shuffleNhie;
        if(el("shufflePick")) el("shufflePick").checked = settings.shufflePick;
      }else{
        alert("Wrong password");
      }
    });

    el("shuffleNhie")?.addEventListener("change", () => {
      settings.shuffleNhie = !!el("shuffleNhie").checked;
      saveSettings();
    });
    el("shufflePick")?.addEventListener("change", () => {
      settings.shufflePick = !!el("shufflePick").checked;
      saveSettings();
    });

    el("addNhie")?.addEventListener("click", ()=>{
      const v = (el("nhieNew").value || "").trim();
      if(!v) return;
      questions.nhie.unshift(v);
      el("nhieNew").value="";
      saveQuestions(); renderLists();
    });

    el("clearNhie")?.addEventListener("click", ()=>{
      if(!confirm("Clear all NHIE questions?")) return;
      questions.nhie = [];
      saveQuestions(); renderLists();
    });

    el("addPick")?.addEventListener("click", ()=>{
      const q = (el("pickQ").value || "").trim() || "Pick one";
      const o1 = (el("pickO1").value || "").trim();
      const o2 = (el("pickO2").value || "").trim();
      if(!o1 || !o2) return alert("Fill both options.");
      questions.pick.unshift({q,o1,o2});
      el("pickQ").value=""; el("pickO1").value=""; el("pickO2").value="";
      saveQuestions(); renderLists();
    });

    el("clearPick")?.addEventListener("click", ()=>{
      if(!confirm("Clear all Pick One questions?")) return;
      questions.pick = [];
      saveQuestions(); renderLists();
    });

    el("addTruth")?.addEventListener("click", ()=>{
      const v = (el("truthNew").value || "").trim();
      if(!v) return;
      questions.truth.unshift(v);
      el("truthNew").value="";
      saveQuestions(); renderLists();
    });
    el("clearTruth")?.addEventListener("click", ()=>{
      if(!confirm("Clear all Truth questions?")) return;
      questions.truth = [];
      saveQuestions(); renderLists();
    });

    el("addDare")?.addEventListener("click", ()=>{
      const v = (el("dareNew").value || "").trim();
      if(!v) return;
      questions.dare.unshift(v);
      el("dareNew").value="";
      saveQuestions(); renderLists();
    });
    el("clearDare")?.addEventListener("click", ()=>{
      if(!confirm("Clear all Dare questions?")) return;
      questions.dare = [];
      saveQuestions(); renderLists();
    });

    el("loadSample")?.addEventListener("click", ()=>{
      questions.nhie = deepClone(SAMPLE_Q.nhie);
      questions.pick = deepClone(SAMPLE_Q.pick);
      questions.truth = deepClone(SAMPLE_Q.truth);
      questions.dare = deepClone(SAMPLE_Q.dare);
      saveQuestions(); renderLists();
      alert("Sample loaded âœ…");
    });

    el("wipeAll")?.addEventListener("click", ()=>{
      if(!confirm("Reset EVERYTHING?")) return;
      localStorage.removeItem(QKEY);
      localStorage.removeItem(SKEY);
      localStorage.removeItem("admin_unlocked_supabase");
      location.reload();
    });

    el("overlay")?.addEventListener("click", (e)=>{
      const dn = e.target?.getAttribute?.("data-del-nhie");
      const dp = e.target?.getAttribute?.("data-del-pick");
      const dt = e.target?.getAttribute?.("data-del-truth");
      const dd = e.target?.getAttribute?.("data-del-dare");

      if(dn != null){
        questions.nhie.splice(Number(dn),1);
        saveQuestions(); renderLists();
      }
      if(dp != null){
        questions.pick.splice(Number(dp),1);
        saveQuestions(); renderLists();
      }
      if(dt != null){
        questions.truth.splice(Number(dt),1);
        saveQuestions(); renderLists();
      }
      if(dd != null){
        questions.dare.splice(Number(dd),1);
        saveQuestions(); renderLists();
      }
    });

    el("tdSpinBtn")?.addEventListener("click", tdSpin);
    el("wheelSpinBtn")?.addEventListener("click", tdSpin);
    el("tdShuffleBtn")?.addEventListener("click", tdShuffleSample);
    el("tdNextBtn")?.addEventListener("click", tdNextSpin);

    el("tdCards")?.addEventListener("click", (e)=>{
      const i = e.target?.getAttribute?.("data-tdpick");
      if(i == null) return;
      tdChoose(Number(i));
    });

    el("chatSendBtn")?.addEventListener("click", chatSendText);
    el("chatInput")?.addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){
        e.preventDefault();
        chatSendText();
      }
    });

    el("chatImgBtn")?.addEventListener("click", ()=>{
      showChatErr("");
      el("chatFile")?.click();
    });

    el("chatFile")?.addEventListener("change", ()=>{
      const f = el("chatFile").files?.[0] || null;
      if(!f) return;
      chatSendImage(f);
    });

    async function ensureAnonAuth(){
      const { data: sess } = await supabase.auth.getSession();
      if(sess?.session?.user?.id) return sess.session.user.id;
      const { data, error } = await supabase.auth.signInAnonymously();
      if(error) throw error;
      return data.user.id;
    }

    async function boot(){
      loadQuestions();
      loadSettings();
      setScreen("screenHome");

      renderWheelLabels();
      setText("topSub","");

      const url = new URL(window.location.href);
      const roomFromUrl = cleanRoomId(url.searchParams.get("room") || "");
      if(roomFromUrl){
        if(el("roomIdJoin")) el("roomIdJoin").value = roomFromUrl;
        setText("topSub", "Room link opened. Enter your name & Join.");
        setTimeout(()=> el("myNameJoin")?.focus(), 250);
      }

      try{
        client.uid = await ensureAnonAuth();
        setText("authInfo", "Connected (uid: " + client.uid.slice(0,8) + "â€¦)");
      }catch(e){
        console.error(e);
        showHomeError("Auth error: " + (e?.message || "anonymous auth not enabled"));
      }
    }

    boot();
  </script>
</body>
</html>
